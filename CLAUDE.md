# CLAUDE.md - Claude Code Configuration for CAFI MRB Analysis

## Project Overview

This repository contains the analysis pipeline for a coral reef field experiment examining how coral habitat quantity affects coral-associated fish and invertebrate (CAFI) community assembly in Moorea, French Polynesia.

**Key Scientific Question:** How does coral density (1, 3, or 6 colonies per reef patch) affect CAFI communities and coral performance over a 2-year period?

## Primary Interface: The Orchestrator

**IMPORTANT:** When the user asks you to perform analysis tasks, generate figures, run statistics, or manage the pipeline, use the Python agent system located in `agents/`.

The main entry point is the **Orchestrator** (`agents/orchestrator.py`), which coordinates all specialized agents.

### Quick Reference

```python
# Import and initialize
import sys
sys.path.insert(0, 'agents')
from orchestrator import Orchestrator

orch = Orchestrator()

# Check status
status = orch.get_status()

# Run analyses
results = orch.run_full_analysis()
results = orch.run_quick_analysis()

# Generate manuscript materials
materials = orch.generate_manuscript_materials()

# Validate data
report = orch.validate_and_report()
```

### Available Agents

| Agent | Purpose | Key Methods |
|-------|---------|-------------|
| `Orchestrator` | Main coordinator | `run_full_analysis()`, `run_quick_analysis()`, `generate_manuscript_materials()` |
| `PipelineAgent` | Run R scripts | `run_script()`, `run_pipeline()`, `check_dependencies()` |
| `StatsAgent` | Statistics & R code | `generate_lmm_analysis_script()`, `generate_permanova_script()`, `extract_key_results()` |
| `FigureAgent` | Figures & R code | `generate_figure_r_script()`, `generate_treatment_comparison_figure()` |
| `ValidationAgent` | Data quality | `run_all_validations()`, `validate_required_files()` |

## Code Generation Philosophy

**All generated analysis code is in R**, integrating with the existing CAFI R pipeline. The Python agents are orchestrators that:
1. Generate R scripts following CAFI conventions
2. Execute R scripts via `Rscript`
3. Parse and interpret R output
4. Manage dependencies and workflows

When asked to create a new analysis or figure, generate an R script using the appropriate agent method.

## Common Tasks

### "Run the analysis pipeline"
```python
from orchestrator import Orchestrator
orch = Orchestrator()
results = orch.run_full_analysis()
```

### "Generate a figure comparing X by treatment"
```python
from figure_agent import FigureAgent
agent = FigureAgent()
script, path = agent.generate_treatment_comparison_figure(
    response_var="variable_name",
    response_label="Human Readable Label",
    run_script=True
)
```

### "Analyze treatment effects on Y"
```python
from stats_agent import StatsAgent
agent = StatsAgent()
script, path = agent.generate_lmm_analysis_script(
    analysis_name="my_analysis",
    response_var="response_variable",
    fixed_effects=["treatment"],
    run_script=True
)
```

### "Check data quality"
```python
from validation_agent import ValidationAgent
agent = ValidationAgent()
report = agent.run_all_validations()
```

### "What are the key statistical results?"
```python
from stats_agent import StatsAgent
agent = StatsAgent()
results = agent.extract_key_results()
summary = agent.generate_results_summary()
```

## Repository Structure

```
├── agents/                    # Python agent system (USE THIS)
│   ├── orchestrator.py        # Main coordinator
│   ├── pipeline_agent.py      # R script execution
│   ├── stats_agent.py         # Statistical analysis + R code gen
│   ├── figure_agent.py        # Figure management + R code gen
│   ├── validation_agent.py    # Data validation
│   └── r_code_generator.py    # R code templates
│
├── scripts/MRB/               # R analysis scripts
│   ├── 1.libraries.R          # Package loading
│   ├── utils.R                # Utility functions
│   ├── 6.coral-growth.R       # Growth analysis
│   ├── 7.coral-physiology.R   # Physiology analysis
│   ├── 8.coral-caffi.R        # CAFI-coral relationships
│   └── agent_generated/       # Scripts generated by agents
│
├── data/MRB Amount/           # Raw data files
├── output/MRB/                # Analysis outputs
│   ├── figures/               # Generated figures
│   └── tables/                # Statistical tables
```

## Key Data Files

- `1. mrb_fe_cafi_summer_2021_v4_AP_updated_2024.csv` - CAFI community data
- `coral_id_position_treatment.csv` - Treatment assignments
- `1. amount_master_phys_data_v5.csv` - Coral physiology
- `MRB_2019_200K_mesh_measure.csv` - Initial growth measurements
- `MRB_May_2021_200K_mesh_measure.csv` - Final growth measurements

## Treatment Groups

- **1**: Single coral colony per reef patch
- **3**: Three coral colonies per reef patch
- **6**: Six coral colonies per reef patch

## Statistical Approaches

- **LMM**: Linear mixed models with reef as random effect (`lmerTest`)
- **PERMANOVA**: Community composition analysis (`vegan::adonis2`)
- **PCA**: Multivariate performance metrics
- **Post-hoc**: Tukey-adjusted pairwise comparisons (`emmeans`)

## R Package Dependencies

Core packages: `tidyverse`, `lmerTest`, `emmeans`, `vegan`, `ggplot2`, `patchwork`, `here`

All packages are loaded via `scripts/MRB/1.libraries.R`

## Notes for Claude

1. **Always use the agent system** for analysis tasks rather than writing raw R code directly
2. **Generated R scripts go to** `scripts/MRB/agent_generated/`
3. **Generated figures go to** `output/MRB/figures/agent_generated/`
4. **The agents handle** proper sourcing of libraries and utilities
5. **When running scripts**, agents execute from the project root using `here::here()`
