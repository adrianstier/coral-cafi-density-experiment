# CAFI MRB Analysis Agents

A suite of Python agents for automating and orchestrating the coral reef (CAFI) analysis pipeline.

**IMPORTANT**: All analysis code generated by these agents is in **R**, integrating seamlessly with the existing CAFI R analysis pipeline. The agents themselves are Python-based orchestrators, but they generate and execute R code.

## Overview

This agent system provides intelligent automation for the MRB coral-CAFI analysis, including:

- **Pipeline Orchestration**: Automated R script execution with dependency management
- **Statistical Analysis**: Result extraction, interpretation, and **R code generation for new analyses**
- **Figure Generation**: Publication-quality **R/ggplot2 figure scripts** and quality control
- **Data Validation**: Comprehensive data quality checks and reproducibility verification
- **R Code Generation**: Automatically generate R scripts for LMM, PERMANOVA, PCA, and visualization

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                      ORCHESTRATOR                            │
│  Coordinates all agents, provides high-level workflows       │
└─────────────────────────────────────────────────────────────┘
          │              │              │              │
          ▼              ▼              ▼              ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│   Pipeline   │ │    Stats     │ │   Figure     │ │  Validation  │
│    Agent     │ │    Agent     │ │    Agent     │ │    Agent     │
├──────────────┤ ├──────────────┤ ├──────────────┤ ├──────────────┤
│ • Run scripts│ │ • Extract    │ │ • Generate   │ │ • Validate   │
│ • Manage deps│ │   results    │ │   figures    │ │   data       │
│ • Validate   │ │ • Format for │ │ • Check      │ │ • Check      │
│   outputs    │ │   manuscript │ │   quality    │ │   integrity  │
│ • Reports    │ │ • Interpret  │ │ • Export     │ │ • Checksums  │
└──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘
```

## Quick Start

### Python API

```python
from agents import Orchestrator

# Initialize
orch = Orchestrator()

# Check status
status = orch.get_status()
print(f"Environment OK: {status['environment']['all_ok']}")

# Run full analysis
results = orch.run_full_analysis()

# Generate manuscript materials
materials = orch.generate_manuscript_materials()
```

### Command Line Interface

```bash
# Check overall status
python -m agents --status

# Run full analysis workflow
python -m agents --run-full

# Run quick analysis (core scripts only)
python -m agents --run-quick

# Validate data quality
python -m agents --validate

# Generate manuscript materials
python -m agents --manuscript

# Query the analysis
python -m agents --query "What are the significant treatment effects?"
```

## Individual Agents

### Pipeline Agent

Orchestrates R script execution with intelligent dependency management.

```bash
# List available scripts
python pipeline_agent.py --list

# Run specific script
python pipeline_agent.py --script 6.coral-growth

# Run full pipeline
python pipeline_agent.py --run-all

# Check dependencies
python pipeline_agent.py --check-deps 8.coral-caffi

# Dry run (check without executing)
python pipeline_agent.py --run-all --dry-run
```

### Stats Agent

Extracts statistical results and **generates R code for new analyses**.

```bash
# Show results summary
python stats_agent.py --summary

# Show treatment effects
python stats_agent.py --treatment

# Show community composition results
python stats_agent.py --community

# Export to CSV
python stats_agent.py --export-csv

# Export to markdown
python stats_agent.py --export-markdown
```

**R Code Generation (Python API):**

```python
from agents import StatsAgent

agent = StatsAgent()

# Generate an LMM analysis R script
script, path = agent.generate_lmm_analysis_script(
    analysis_name="abundance_treatment",
    response_var="total_abundance",
    fixed_effects=["treatment"],
    random_effect="reef",
    run_script=True  # Optionally execute immediately
)

# Generate a PERMANOVA R script
script, path = agent.generate_permanova_script(
    analysis_name="community_composition",
    grouping_var="treatment",
    run_script=False
)

# Generate a PCA R script
script, path = agent.generate_pca_analysis_script(
    analysis_name="physiology_pca",
    variables=["carbohydrate", "protein", "zooxanthellae"],
    run_script=False
)
```

### Figure Agent

Manages publication figures and **generates R/ggplot2 code for new figures**.

```bash
# Check figure status
python figure_agent.py --status

# Generate specific figure
python figure_agent.py --generate 1

# Generate all figures
python figure_agent.py --generate-all

# Run quality checks
python figure_agent.py --quality-check

# Create figure archive
python figure_agent.py --create-archive

# Create R styling script
python figure_agent.py --create-style
```

**R Code Generation (Python API):**

```python
from agents import FigureAgent

agent = FigureAgent()

# Generate an R script for a treatment comparison figure
script, path = agent.generate_treatment_comparison_figure(
    response_var="total_abundance",
    response_label="Total CAFI Abundance",
    plot_type="boxplot",
    run_script=True
)

# Generate a custom figure R script
script, path = agent.generate_figure_r_script(
    figure_name="diversity_by_treatment",
    description="Species richness by treatment",
    data_sources=["cafi", "treatment"],
    x_var="treatment",
    y_var="richness",
    plot_type="violin",
    fill_var="treatment",
    title="Species Richness by Treatment",
    run_script=False
)

# Generate multi-panel figure R script
script, path = agent.generate_multi_panel_figure(
    figure_name="community_summary",
    panels=[
        {"name": "p1", "y_var": "abundance", "title": "Abundance"},
        {"name": "p2", "y_var": "richness", "title": "Richness"},
        {"name": "p3", "y_var": "evenness", "title": "Evenness"},
    ],
    ncol=3
)
```

### R Code Generator

Direct R code generation tool for creating analysis scripts.

```bash
# Generate treatment effect analysis R script
python r_code_generator.py --treatment-effect abundance "CAFI Abundance"

# Generate figure script template
python r_code_generator.py --figure-script my_figure "Treatment comparison"

# Generate analysis script template
python r_code_generator.py --analysis-script my_analysis "LMM analysis"
```

### Validation Agent

Ensures data quality and reproducibility.

```bash
# Run all validations
python validation_agent.py --validate-all

# Check required files
python validation_agent.py --check-files

# Check data quality
python validation_agent.py --check-quality

# Compute checksums
python validation_agent.py --checksums

# Generate full report
python validation_agent.py --report
```

## Workflows

### Full Analysis Workflow

The `--run-full` workflow executes:

1. **Data Validation**: Check all required files and data quality
2. **R Pipeline**: Execute all analysis scripts in dependency order
3. **Statistics Compilation**: Extract and format key results
4. **Figure Check**: Verify all publication figures exist

### Quick Analysis Workflow

The `--run-quick` workflow focuses on core analyses:

1. `6.coral-growth.R` - Allometric growth analysis
2. `7.coral-physiology.R` - Physiology integration
3. `14.compile-manuscript-statistics.R` - Statistics compilation

### Manuscript Materials Workflow

The `--manuscript` workflow generates:

- Statistics CSV and Markdown summaries
- Figure archive (ZIP)
- Validation report
- Figure quality assessment

## Configuration

All configuration is centralized in `config.py`:

- **Paths**: Project root, data directories, output locations
- **Scripts**: Pipeline script configurations and dependencies
- **Data Files**: Required data file specifications
- **Figures**: Publication figure configurations
- **Statistical Tests**: Key test configurations

## Output Files

The agents generate outputs in:

```
output/MRB/
├── logs/
│   ├── orchestrator.log
│   ├── pipeline_agent.log
│   ├── stats_agent.log
│   ├── figure_agent.log
│   ├── validation_agent.log
│   └── pipeline_report_*.json
├── tables/
│   └── stats_agent_results.csv
├── validation_report.json
├── VALIDATION_REPORT.md
├── KEY_STATISTICS_AGENT.md
├── figure_quality_check.json
└── publication_figures.zip
```

## Requirements

### Python Dependencies

- Python 3.8+
- Standard library only (no external dependencies required)
- Optional: `Pillow` for image dimension checks

### R Dependencies

The R scripts require packages defined in `scripts/MRB/1.libraries.R`:
- tidyverse, lmerTest, emmeans, vegan, etc.

## Integration with Claude Code

These agents are designed to work with Claude Code for intelligent assistance:

```python
# Example: Ask Claude Code to analyze results
from agents import Orchestrator

orch = Orchestrator()
results = orch.run_full_analysis()

# Claude Code can then interpret:
# - Statistical significance
# - Effect sizes
# - Figure quality issues
# - Data validation warnings
```

## Extending the Agents

### Adding a New Agent

1. Create `new_agent.py` in the `agents/` directory
2. Follow the pattern of existing agents (init, logging, methods, CLI)
3. Add to `__init__.py` exports
4. Integrate with `orchestrator.py` if needed

### Adding New Scripts to Pipeline

1. Add script configuration to `PIPELINE_SCRIPTS` in `config.py`
2. Update `PIPELINE_ORDER` with correct position
3. Define any required data files in `REQUIRED_DATA_FILES`

## Troubleshooting

### R Script Failures

Check the log files in `output/MRB/logs/` for detailed error messages. Common issues:

- Missing R packages: Run `scripts/MRB/1.libraries.R` first
- Missing data files: Run validation agent to check
- Path issues: Ensure you're running from project root

### Data Validation Issues

Run `python validation_agent.py --validate-all` to see all issues. Common problems:

- Missing required columns
- Invalid treatment values
- Inconsistent coral IDs across files

### Figure Generation Issues

Check that source R scripts complete successfully. The figure agent wraps R script execution.

## License

CC-BY 4.0 (matching the main repository license)

## Authors

CAFI Analysis Team, 2025
