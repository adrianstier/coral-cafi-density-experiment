"""
R Code Generator for CAFI MRB Analysis Agents
==============================================
Generates R code for figures, statistical analyses, and data processing.
All generated code follows the existing CAFI R pipeline conventions.

Author: CAFI Analysis Team
Created: 2025-01-11
"""

import sys
from pathlib import Path
from typing import Dict, List, Optional, Any
from dataclasses import dataclass
from datetime import datetime
from textwrap import dedent

# Add parent directory to path for imports
sys.path.insert(0, str(Path(__file__).parent))

from config import PROJECT_ROOT, SCRIPTS_DIR, OUTPUT_DIR


# =============================================================================
# R CODE TEMPLATES
# =============================================================================

class RCodeTemplates:
    """Templates for generating R code."""

    @staticmethod
    def script_header(
        title: str,
        description: str,
        inputs: List[str] = None,
        outputs: List[str] = None,
        dependencies: List[str] = None
    ) -> str:
        """Generate a standard R script header."""
        inputs = inputs or ["None specified"]
        outputs = outputs or ["None specified"]
        dependencies = dependencies or ["1.libraries.R"]

        return dedent(f'''
        # ==============================================================================
        # {title}
        # ==============================================================================
        # Purpose: {description}
        #
        # Inputs:
        #   {chr(10).join(f"#   - {i}" for i in inputs)}
        #
        # Outputs:
        #   {chr(10).join(f"#   - {o}" for o in outputs)}
        #
        # Dependencies:
        #   {chr(10).join(f"#   - {d}" for d in dependencies)}
        #
        # Generated by: CAFI Agent System
        # Generated on: {datetime.now().strftime("%Y-%m-%d %H:%M")}
        # ==============================================================================

        # Load libraries and utilities
        source(here::here("scripts", "MRB", "1.libraries.R"))
        source(here::here("scripts", "MRB", "utils.R"))
        source(here::here("scripts", "MRB", "mrb_figure_standards.R"))

        ''').strip() + "\n\n"

    @staticmethod
    def load_data_block(data_sources: List[str]) -> str:
        """Generate data loading code."""
        code = "# ==============================================================================\n"
        code += "# LOAD DATA\n"
        code += "# ==============================================================================\n\n"

        for source in data_sources:
            if source == "cafi":
                code += "cafi_data <- load_cafi_data()\n"
            elif source == "treatment":
                code += "treatment_data <- load_treatment_data()\n"
            elif source == "growth":
                code += "growth_data <- load_coral_growth_data()\n"
            elif source == "physiology":
                code += dedent('''
                physio_data <- read_csv(
                  here::here("data", "MRB Amount", "1. amount_master_phys_data_v5.csv"),
                  show_col_types = FALSE
                )
                ''').strip() + "\n"

        return code + "\n"

    @staticmethod
    def ggplot_figure(
        plot_name: str,
        data_var: str,
        x_var: str,
        y_var: str,
        plot_type: str = "boxplot",
        color_var: Optional[str] = None,
        fill_var: Optional[str] = None,
        facet_var: Optional[str] = None,
        title: str = "",
        x_label: str = "",
        y_label: str = "",
        width: float = 8,
        height: float = 6,
        output_path: str = ""
    ) -> str:
        """Generate ggplot2 figure code."""

        # Build the ggplot call
        aes_parts = [f"x = {x_var}", f"y = {y_var}"]
        if color_var:
            aes_parts.append(f"color = {color_var}")
        if fill_var:
            aes_parts.append(f"fill = {fill_var}")

        aes_str = ", ".join(aes_parts)

        # Build geom layer
        if plot_type == "boxplot":
            geom = "geom_boxplot(outlier.shape = NA, alpha = 0.7)"
        elif plot_type == "point":
            geom = "geom_point(size = 3, alpha = 0.8)"
        elif plot_type == "line":
            geom = "geom_line(linewidth = 1)"
        elif plot_type == "bar":
            geom = "geom_bar(stat = 'identity', alpha = 0.8)"
        elif plot_type == "violin":
            geom = "geom_violin(alpha = 0.7) +\n  geom_boxplot(width = 0.1, alpha = 0.9)"
        else:
            geom = f"geom_{plot_type}()"

        code = dedent(f'''
        # ------------------------------------------------------------------------------
        # {plot_name}
        # ------------------------------------------------------------------------------

        {plot_name} <- ggplot({data_var}, aes({aes_str})) +
          {geom} +
          labs(
            title = "{title}",
            x = "{x_label}",
            y = "{y_label}"
          ) +
          theme_cafi_pub()
        ''').strip()

        # Add color/fill scales if treatment
        if color_var == "treatment" or fill_var == "treatment":
            code += "\n\n# Apply treatment color scale\n"
            if color_var == "treatment":
                code += f"{plot_name} <- {plot_name} +\n  scale_color_manual(values = treatment_colors, labels = treatment_labels)\n"
            if fill_var == "treatment":
                code += f"{plot_name} <- {plot_name} +\n  scale_fill_manual(values = treatment_colors, labels = treatment_labels)\n"

        # Add faceting
        if facet_var:
            code += f"\n{plot_name} <- {plot_name} +\n  facet_wrap(~ {facet_var})\n"

        # Add save code
        if output_path:
            code += dedent(f'''

            # Save figure
            save_both(
              {plot_name},
              here::here("{output_path}"),
              width = {width},
              height = {height}
            )
            ''').strip()

        return code + "\n\n"

    @staticmethod
    def lmm_analysis(
        model_name: str,
        response_var: str,
        fixed_effects: List[str],
        random_effect: str = "reef",
        data_var: str = "data",
        include_posthoc: bool = True,
        include_emmeans: bool = True
    ) -> str:
        """Generate linear mixed model analysis code."""

        fixed_formula = " + ".join(fixed_effects)
        formula = f"{response_var} ~ {fixed_formula} + (1 | {random_effect})"

        code = dedent(f'''
        # ------------------------------------------------------------------------------
        # Mixed-Effects Model: {model_name}
        # ------------------------------------------------------------------------------

        # Fit the model
        {model_name} <- lmer(
          {formula},
          data = {data_var}
        )

        # Model summary
        cat("\\n=== Model Summary: {model_name} ===\\n")
        print(summary({model_name}))

        # Type III Wald chi-square tests
        {model_name}_anova <- car::Anova({model_name}, type = 3)
        cat("\\n=== ANOVA Table ===\\n")
        print({model_name}_anova)

        # Tidy output for reporting
        {model_name}_tidy <- broom.mixed::tidy({model_name}, effects = "fixed", conf.int = TRUE)
        print({model_name}_tidy)
        ''').strip()

        if include_emmeans:
            code += dedent(f'''

            # Estimated marginal means
            {model_name}_emmeans <- emmeans({model_name}, specs = ~ {fixed_effects[0]})
            cat("\\n=== Estimated Marginal Means ===\\n")
            print({model_name}_emmeans)
            ''').strip()

        if include_posthoc and len(fixed_effects) > 0:
            code += dedent(f'''

            # Post-hoc pairwise comparisons
            {model_name}_posthoc <- pairs({model_name}_emmeans, adjust = "tukey")
            cat("\\n=== Post-hoc Comparisons (Tukey) ===\\n")
            print({model_name}_posthoc)
            ''').strip()

        return code + "\n\n"

    @staticmethod
    def permanova_analysis(
        matrix_var: str,
        grouping_var: str,
        metadata_var: str = "metadata",
        method: str = "bray",
        permutations: int = 999
    ) -> str:
        """Generate PERMANOVA analysis code."""

        return dedent(f'''
        # ------------------------------------------------------------------------------
        # PERMANOVA Analysis
        # ------------------------------------------------------------------------------

        # Run PERMANOVA
        permanova_result <- vegan::adonis2(
          {matrix_var} ~ {grouping_var},
          data = {metadata_var},
          method = "{method}",
          permutations = {permutations}
        )

        cat("\\n=== PERMANOVA Results ===\\n")
        print(permanova_result)

        # Calculate R-squared
        r2 <- permanova_result$R2[1]
        f_stat <- permanova_result$F[1]
        p_value <- permanova_result$"Pr(>F)"[1]

        cat(sprintf("\\nRÂ² = %.3f, F = %.2f, p = %.4f\\n", r2, f_stat, p_value))
        ''').strip() + "\n\n"

    @staticmethod
    def nmds_ordination(
        matrix_var: str,
        k: int = 2,
        trymax: int = 100
    ) -> str:
        """Generate NMDS ordination code."""

        return dedent(f'''
        # ------------------------------------------------------------------------------
        # NMDS Ordination
        # ------------------------------------------------------------------------------

        set.seed(42)  # For reproducibility

        # Run NMDS
        nmds_result <- vegan::metaMDS(
          {matrix_var},
          k = {k},
          trymax = {trymax},
          distance = "bray"
        )

        cat("\\n=== NMDS Results ===\\n")
        cat(sprintf("Stress: %.4f\\n", nmds_result$stress))

        # Extract scores for plotting
        nmds_scores <- as.data.frame(scores(nmds_result, display = "sites"))
        nmds_scores$sample_id <- rownames(nmds_scores)
        ''').strip() + "\n\n"

    @staticmethod
    def pca_analysis(
        data_var: str,
        scale: bool = True,
        center: bool = True
    ) -> str:
        """Generate PCA analysis code."""

        return dedent(f'''
        # ------------------------------------------------------------------------------
        # Principal Component Analysis
        # ------------------------------------------------------------------------------

        # Run PCA
        pca_result <- prcomp(
          {data_var},
          scale. = {str(scale).upper()},
          center = {str(center).upper()}
        )

        # Summary
        cat("\\n=== PCA Summary ===\\n")
        print(summary(pca_result))

        # Extract variance explained
        var_explained <- pca_result$sdev^2 / sum(pca_result$sdev^2) * 100

        cat(sprintf("\\nPC1 explains %.1f%% of variance\\n", var_explained[1]))
        cat(sprintf("PC2 explains %.1f%% of variance\\n", var_explained[2]))

        # Extract scores
        pca_scores <- as.data.frame(pca_result$x)

        # Extract loadings
        pca_loadings <- as.data.frame(pca_result$rotation)
        ''').strip() + "\n\n"

    @staticmethod
    def save_results_table(
        data_var: str,
        filename: str,
        format: str = "csv"
    ) -> str:
        """Generate code to save results table."""

        if format == "csv":
            return dedent(f'''
            # Save results to CSV
            write_csv(
              {data_var},
              here::here("output", "MRB", "tables", "{filename}.csv")
            )
            message("Saved: {filename}.csv")
            ''').strip() + "\n\n"
        elif format == "html":
            return dedent(f'''
            # Save results as HTML table
            {data_var} %>%
              gt::gt() %>%
              gt::gtsave(here::here("output", "MRB", "tables", "{filename}.html"))
            message("Saved: {filename}.html")
            ''').strip() + "\n\n"
        else:
            return f"# Unknown format: {format}\n\n"


# =============================================================================
# R CODE GENERATOR CLASS
# =============================================================================

class RCodeGenerator:
    """
    Generator for R analysis scripts.

    Creates complete, runnable R scripts that follow CAFI conventions.
    """

    def __init__(self):
        self.templates = RCodeTemplates()

    def generate_figure_script(
        self,
        figure_name: str,
        description: str,
        data_sources: List[str],
        plots: List[Dict[str, Any]],
        output_dir: str = "output/MRB/figures"
    ) -> str:
        """
        Generate a complete R script for creating figures.

        Args:
            figure_name: Name of the figure/script
            description: Description of what the figure shows
            data_sources: List of data sources to load
            plots: List of plot configurations
            output_dir: Output directory for figures

        Returns:
            Complete R script as string
        """
        script = self.templates.script_header(
            title=f"Figure Generation: {figure_name}",
            description=description,
            inputs=[f"Data: {s}" for s in data_sources],
            outputs=[f"{output_dir}/{figure_name}.png/pdf"]
        )

        script += self.templates.load_data_block(data_sources)

        # Add data preparation section
        script += "# ==============================================================================\n"
        script += "# DATA PREPARATION\n"
        script += "# ==============================================================================\n\n"
        script += "# Add any data transformations here\n\n"

        # Generate each plot
        script += "# ==============================================================================\n"
        script += "# GENERATE FIGURES\n"
        script += "# ==============================================================================\n\n"

        for i, plot_config in enumerate(plots):
            script += self.templates.ggplot_figure(**plot_config)

        script += "# ==============================================================================\n"
        script += "# SCRIPT COMPLETE\n"
        script += "# ==============================================================================\n"
        script += f'message("Figure script complete: {figure_name}")\n'

        return script

    def generate_analysis_script(
        self,
        analysis_name: str,
        description: str,
        data_sources: List[str],
        analyses: List[Dict[str, Any]],
        output_tables: List[str] = None
    ) -> str:
        """
        Generate a complete R script for statistical analysis.

        Args:
            analysis_name: Name of the analysis
            description: Description of the analysis
            data_sources: List of data sources to load
            analyses: List of analysis configurations
            output_tables: List of table names to save

        Returns:
            Complete R script as string
        """
        output_tables = output_tables or []

        script = self.templates.script_header(
            title=f"Statistical Analysis: {analysis_name}",
            description=description,
            inputs=[f"Data: {s}" for s in data_sources],
            outputs=[f"Table: {t}" for t in output_tables]
        )

        script += self.templates.load_data_block(data_sources)

        # Add analysis sections
        script += "# ==============================================================================\n"
        script += "# STATISTICAL ANALYSES\n"
        script += "# ==============================================================================\n\n"

        for analysis in analyses:
            analysis_type = analysis.get("type", "lmm")

            if analysis_type == "lmm":
                script += self.templates.lmm_analysis(**{k: v for k, v in analysis.items() if k != "type"})
            elif analysis_type == "permanova":
                script += self.templates.permanova_analysis(**{k: v for k, v in analysis.items() if k != "type"})
            elif analysis_type == "nmds":
                script += self.templates.nmds_ordination(**{k: v for k, v in analysis.items() if k != "type"})
            elif analysis_type == "pca":
                script += self.templates.pca_analysis(**{k: v for k, v in analysis.items() if k != "type"})

        # Save tables
        if output_tables:
            script += "# ==============================================================================\n"
            script += "# SAVE RESULTS\n"
            script += "# ==============================================================================\n\n"

            for table in output_tables:
                script += self.templates.save_results_table(table, table)

        script += "# ==============================================================================\n"
        script += "# ANALYSIS COMPLETE\n"
        script += "# ==============================================================================\n"
        script += f'message("Analysis complete: {analysis_name}")\n'

        return script

    def generate_treatment_effect_script(
        self,
        response_var: str,
        response_label: str,
        data_source: str = "cafi",
        include_figure: bool = True
    ) -> str:
        """
        Generate a script to analyze treatment effects on a response variable.

        Args:
            response_var: Name of the response variable
            response_label: Human-readable label for plots
            data_source: Data source to use
            include_figure: Whether to include figure generation

        Returns:
            Complete R script
        """
        script = self.templates.script_header(
            title=f"Treatment Effect Analysis: {response_var}",
            description=f"Analyze treatment effects on {response_label}",
            inputs=[data_source],
            outputs=[f"{response_var}_treatment_effect.csv", f"{response_var}_boxplot.png"]
        )

        script += self.templates.load_data_block([data_source, "treatment"])

        # Merge data
        script += dedent('''
        # ==============================================================================
        # MERGE DATA
        # ==============================================================================

        analysis_data <- cafi_data %>%
          left_join(treatment_data, by = "coral_id") %>%
          filter(!is.na(treatment))

        ''')

        # Add LMM analysis
        script += self.templates.lmm_analysis(
            model_name=f"{response_var}_model",
            response_var=response_var,
            fixed_effects=["treatment"],
            random_effect="reef",
            data_var="analysis_data"
        )

        # Add figure if requested
        if include_figure:
            script += self.templates.ggplot_figure(
                plot_name=f"{response_var}_plot",
                data_var="analysis_data",
                x_var="treatment",
                y_var=response_var,
                plot_type="boxplot",
                fill_var="treatment",
                title=f"Treatment Effect on {response_label}",
                x_label="Treatment (# Corals)",
                y_label=response_label,
                output_path=f"output/MRB/figures/{response_var}_treatment"
            )

        return script

    def save_script(self, script: str, filename: str, directory: Path = None) -> Path:
        """
        Save generated R script to file.

        Args:
            script: R script content
            filename: Output filename (without .R extension)
            directory: Output directory (default: scripts/MRB/agent_generated)

        Returns:
            Path to saved script
        """
        directory = directory or (SCRIPTS_DIR / "agent_generated")
        directory.mkdir(parents=True, exist_ok=True)

        output_path = directory / f"{filename}.R"

        with open(output_path, 'w') as f:
            f.write(script)

        return output_path


# =============================================================================
# CLI INTERFACE
# =============================================================================

def main():
    """Command-line interface for R code generator."""
    import argparse

    parser = argparse.ArgumentParser(
        description="CAFI MRB R Code Generator",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  python r_code_generator.py --treatment-effect abundance "CAFI Abundance"
  python r_code_generator.py --figure-script my_figure "Treatment comparison"
  python r_code_generator.py --analysis-script my_analysis "LMM analysis"
        """
    )

    parser.add_argument(
        "--treatment-effect", nargs=2, metavar=("VAR", "LABEL"),
        help="Generate treatment effect analysis script"
    )
    parser.add_argument(
        "--figure-script", nargs=2, metavar=("NAME", "DESC"),
        help="Generate a figure script template"
    )
    parser.add_argument(
        "--analysis-script", nargs=2, metavar=("NAME", "DESC"),
        help="Generate an analysis script template"
    )
    parser.add_argument(
        "--output", type=str,
        help="Output filename (without .R)"
    )

    args = parser.parse_args()

    generator = RCodeGenerator()

    if args.treatment_effect:
        var, label = args.treatment_effect
        script = generator.generate_treatment_effect_script(var, label)
        filename = args.output or f"treatment_effect_{var}"
        path = generator.save_script(script, filename)
        print(f"Generated: {path}")
        return

    if args.figure_script:
        name, desc = args.figure_script
        script = generator.generate_figure_script(
            figure_name=name,
            description=desc,
            data_sources=["cafi", "treatment"],
            plots=[{
                "plot_name": f"{name}_plot",
                "data_var": "data",
                "x_var": "treatment",
                "y_var": "value",
                "plot_type": "boxplot",
                "fill_var": "treatment",
                "title": desc,
                "output_path": f"output/MRB/figures/{name}"
            }]
        )
        filename = args.output or f"figure_{name}"
        path = generator.save_script(script, filename)
        print(f"Generated: {path}")
        return

    if args.analysis_script:
        name, desc = args.analysis_script
        script = generator.generate_analysis_script(
            analysis_name=name,
            description=desc,
            data_sources=["cafi", "treatment"],
            analyses=[{
                "type": "lmm",
                "model_name": f"{name}_model",
                "response_var": "response",
                "fixed_effects": ["treatment"],
                "data_var": "data"
            }]
        )
        filename = args.output or f"analysis_{name}"
        path = generator.save_script(script, filename)
        print(f"Generated: {path}")
        return

    parser.print_help()


if __name__ == "__main__":
    main()
