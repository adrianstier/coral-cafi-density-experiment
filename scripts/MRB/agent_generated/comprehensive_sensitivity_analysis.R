# ==============================================================================
# Comprehensive Sensitivity Analysis for Species Filtering Thresholds
# ==============================================================================
# Purpose: Test robustness of all key results to the 10×10 species filtering rule
#          Generate publication-ready figures and tables showing sensitivity
#
# Key Questions:
#   1. Do qualitative conclusions change with different thresholds?
#   2. How do effect sizes vary across thresholds?
#   3. Is the 10×10 rule conservative or liberal?
#
# Outputs:
#   - Tables: sensitivity_all_analyses.csv, sensitivity_summary.csv
#   - Figures: sensitivity_heatmap.png, sensitivity_effect_sizes.png
#
# Generated by: CAFI Agent System
# Generated on: 2026-01-11
# ==============================================================================

# Load libraries
library(tidyverse)
library(here)
library(lme4)      # Mixed effects models
library(vegan)     # Community analyses
library(patchwork) # Figure composition

# Load utilities and standards
source(here("scripts", "MRB", "utils.R"))
source(here("scripts", "MRB", "mrb_figure_standards.R"))

# ==============================================================================
# CONFIGURATION
# ==============================================================================

# Coral survival threshold - ALIVE_THRESH defined in utils.R (0.80)

# Species filtering thresholds to test
PREVALENCE_THRESHOLDS <- c(5, 10, 15, 20, 25)
ABUNDANCE_THRESHOLDS <- c(5, 10, 20, 30)

# Create all combinations
threshold_grid <- expand.grid(
  min_prev = PREVALENCE_THRESHOLDS,
  min_abund = ABUNDANCE_THRESHOLDS
)

cat("Testing", nrow(threshold_grid), "threshold combinations\n")

# ==============================================================================
# LOAD DATA
# ==============================================================================

cat("\n=== Loading Data ===\n")

# Load coral data (already filtered to >=80% alive)
coral_growth <- read_csv(
  here("data", "processed", "coral_growth.csv"),
  show_col_types = FALSE
)

# coral_growth uses "POC61" format (FE- prefix stripped by script 6)
keep_ids <- coral_growth$coral_id
cat("Corals (>=80% alive):", length(keep_ids), "\n")

# strip_fe() defined in utils.R - sourced above

# Load CAFI data and strip FE- prefix to match coral_growth format
cafi_raw <- load_cafi_data() %>%
  mutate(coral_id = strip_fe(as.character(coral_id)))

# Load treatment data
treatment_df <- load_treatment_data()

# Load physiology data for coral performance PC1
physio_file <- here("output", "MRB", "figures", "coral", "physio",
                    "physio_metrics_plus_growth_filtered.csv")

if (file.exists(physio_file)) {
  physio_df <- read_csv(physio_file, show_col_types = FALSE)
  has_physio <- TRUE
  cat("Physiology data loaded:", nrow(physio_df), "corals\n")
} else {
  has_physio <- FALSE
  cat("Warning: Physiology file not found. Skipping coral performance analyses.\n")
}

# ==============================================================================
# HELPER FUNCTIONS
# ==============================================================================

# Function to filter species by threshold
filter_species <- function(cafi_data, min_prev, min_abund) {
  # Use 'species' column (not 'lowest_level' which is the taxonomic level name)
  species_stats <- cafi_data %>%
    filter(!is.na(species)) %>%
    group_by(species) %>%
    summarise(
      total_count = sum(count, na.rm = TRUE),
      n_corals = n_distinct(coral_id[count > 0]),
      .groups = "drop"
    ) %>%
    filter(total_count >= min_abund, n_corals >= min_prev)

  return(species_stats$species)
}

# Function to create community matrix
create_comm_matrix <- function(cafi_data, species_list, coral_ids) {
  cafi_filtered <- cafi_data %>%
    filter(species %in% species_list, coral_id %in% coral_ids) %>%
    group_by(coral_id, species) %>%
    summarise(abundance = sum(count, na.rm = TRUE), .groups = "drop")

  comm_wide <- cafi_filtered %>%
    pivot_wider(
      names_from = species,
      values_from = abundance,
      values_fill = 0
    )

  # Ensure all corals are present
  missing_corals <- setdiff(coral_ids, comm_wide$coral_id)
  if (length(missing_corals) > 0) {
    empty_rows <- tibble(coral_id = missing_corals) %>%
      bind_cols(setNames(
        as.data.frame(matrix(0, length(missing_corals), length(species_list))),
        species_list
      ))
    comm_wide <- bind_rows(comm_wide, empty_rows)
  }

  comm_wide <- comm_wide %>% arrange(coral_id)

  comm_matrix <- as.matrix(comm_wide[, -1])
  rownames(comm_matrix) <- comm_wide$coral_id

  return(comm_matrix)
}

# Function to run PCA and get PC1 scores
get_cafi_pc1 <- function(comm_matrix) {
  # Handle zero-variance columns
  col_vars <- apply(comm_matrix, 2, var)
  comm_clean <- comm_matrix[, col_vars > 0, drop = FALSE]

  if (ncol(comm_clean) < 3) {
    return(NULL)
  }

  # Run PCA on Hellinger-transformed data
  comm_hell <- decostand(comm_clean, method = "hellinger")
  pca_res <- prcomp(comm_hell, scale. = TRUE)

  pc1_scores <- pca_res$x[, 1]
  var_explained <- summary(pca_res)$importance[2, 1]

  return(list(
    scores = pc1_scores,
    var_explained = var_explained
  ))
}

# Function to get p-value from lmer using likelihood ratio test
get_lrt_pvalue <- function(model_full, model_null) {
  lrt <- anova(model_null, model_full)
  return(lrt$`Pr(>Chisq)`[2])
}

# ==============================================================================
# RUN SENSITIVITY ANALYSES
# ==============================================================================

cat("\n=== Running Sensitivity Analyses ===\n")

results_list <- list()

for (i in 1:nrow(threshold_grid)) {
  min_prev <- threshold_grid$min_prev[i]
  min_abund <- threshold_grid$min_abund[i]

  cat(sprintf("\nThreshold %d/%d: prev >= %d, abund >= %d\n",
              i, nrow(threshold_grid), min_prev, min_abund))

  # Filter species
  species_keep <- filter_species(cafi_raw, min_prev, min_abund)
  n_species <- length(species_keep)
  cat("  Species retained:", n_species, "\n")

  if (n_species < 5) {
    cat("  Skipping: too few species\n")
    next
  }

  # Create community matrix
  comm_matrix <- create_comm_matrix(cafi_raw, species_keep, keep_ids)

  # Get CAFI PC1
  pc1_result <- get_cafi_pc1(comm_matrix)

  if (is.null(pc1_result)) {
    cat("  Skipping: PCA failed\n")
    next
  }

  # Create analysis dataframe
  analysis_df <- tibble(
    coral_id = rownames(comm_matrix),
    PC1_cafi = pc1_result$scores
  ) %>%
    left_join(coral_growth, by = "coral_id") %>%
    mutate(
      treatment = factor(treatment),
      reef = factor(reef)
    )

  # ----- Analysis 1: Treatment effect on CAFI PC1 -----
  tryCatch({
    model_full <- lmer(PC1_cafi ~ treatment + (1 | reef), data = analysis_df, REML = FALSE)
    model_null <- lmer(PC1_cafi ~ 1 + (1 | reef), data = analysis_df, REML = FALSE)

    lrt <- anova(model_null, model_full)
    p_val <- lrt$`Pr(>Chisq)`[2]
    chi_sq <- lrt$Chisq[2]

    # Get effect size as difference between treatment means (1 vs 6)
    means_by_trt <- analysis_df %>%
      group_by(treatment) %>%
      summarise(mean_pc1 = mean(PC1_cafi), .groups = "drop")

    effect_1v6 <- means_by_trt$mean_pc1[means_by_trt$treatment == "1"] -
                  means_by_trt$mean_pc1[means_by_trt$treatment == "6"]

    cafi_result <- tibble(
      analysis = "CAFI_PC1_treatment",
      min_prev = min_prev,
      min_abund = min_abund,
      n_species = n_species,
      var_pc1 = pc1_result$var_explained,
      chi_sq = chi_sq,
      df = 2,  # df for treatment factor
      p_value = p_val,
      effect_size_1v6 = effect_1v6
    )

    results_list[[length(results_list) + 1]] <- cafi_result
    cat("  CAFI PC1 ~ treatment: p =", round(p_val, 4), "\n")

  }, error = function(e) {
    cat("  Error in CAFI analysis:", e$message, "\n")
  })

  # ----- Analysis 2: PERMANOVA on community composition -----
  tryCatch({
    # Get metadata aligned with matrix
    meta_df <- analysis_df %>%
      dplyr::select(coral_id, treatment, reef) %>%
      filter(coral_id %in% rownames(comm_matrix))

    # Ensure order matches
    meta_df <- meta_df[match(rownames(comm_matrix), meta_df$coral_id), ]

    # Run PERMANOVA
    perm_result <- adonis2(
      comm_matrix ~ treatment,
      data = meta_df,
      method = "bray",
      permutations = 999
    )

    permanova_result <- tibble(
      analysis = "PERMANOVA_composition",
      min_prev = min_prev,
      min_abund = min_abund,
      n_species = n_species,
      var_pc1 = NA,
      chi_sq = NA,
      df = perm_result$Df[1],
      p_value = perm_result$`Pr(>F)`[1],
      effect_size_1v6 = perm_result$R2[1]  # R-squared
    )

    results_list[[length(results_list) + 1]] <- permanova_result
    cat("  PERMANOVA: p =", round(permanova_result$p_value, 4),
        ", R2 =", round(permanova_result$effect_size_1v6, 3), "\n")

  }, error = function(e) {
    cat("  Error in PERMANOVA:", e$message, "\n")
  })

  # ----- Analysis 3: CAFI PC1 predicts coral performance -----
  if (has_physio) {
    tryCatch({
      # Merge with physiology data
      perf_df <- analysis_df %>%
        left_join(
          physio_df %>% dplyr::select(coral_id, starts_with("PC1")),
          by = "coral_id"
        )

      # Check for coral performance PC1
      pc1_coral_col <- names(perf_df)[grepl("PC1.*physio|PC1.*coral|PC1.*growth|^PC1$",
                                            names(perf_df), ignore.case = TRUE)]

      if (length(pc1_coral_col) > 0) {
        pc1_coral_col <- pc1_coral_col[1]
        perf_df$PC1_coral <- perf_df[[pc1_coral_col]]

        # Remove rows with missing performance data
        perf_df <- perf_df %>% filter(!is.na(PC1_coral))

        model_full <- lmer(PC1_coral ~ PC1_cafi + (1 | reef), data = perf_df, REML = FALSE)
        model_null <- lmer(PC1_coral ~ 1 + (1 | reef), data = perf_df, REML = FALSE)

        lrt <- anova(model_null, model_full)
        p_val <- lrt$`Pr(>Chisq)`[2]
        chi_sq <- lrt$Chisq[2]

        # Get slope
        slope <- fixef(model_full)["PC1_cafi"]

        perf_result <- tibble(
          analysis = "CAFI_predicts_performance",
          min_prev = min_prev,
          min_abund = min_abund,
          n_species = n_species,
          var_pc1 = pc1_result$var_explained,
          chi_sq = chi_sq,
          df = 1,
          p_value = p_val,
          effect_size_1v6 = slope
        )

        results_list[[length(results_list) + 1]] <- perf_result
        cat("  CAFI -> Performance: p =", round(p_val, 4),
            ", slope =", round(slope, 3), "\n")
      }

    }, error = function(e) {
      cat("  Error in performance analysis:", e$message, "\n")
    })
  }
}

# ==============================================================================
# COMPILE RESULTS
# ==============================================================================

cat("\n=== Compiling Results ===\n")

sensitivity_results <- bind_rows(results_list)

# Add significance indicator
sensitivity_results <- sensitivity_results %>%
  mutate(
    significant_05 = p_value < 0.05,
    significant_10 = p_value < 0.10,
    threshold_label = paste0(min_prev, "/", min_abund)
  )

# Save full results
write_csv(
  sensitivity_results,
  here("output", "MRB", "tables", "sensitivity_all_analyses.csv")
)

cat("Full results saved to: output/MRB/tables/sensitivity_all_analyses.csv\n")

# ==============================================================================
# CREATE SUMMARY TABLE
# ==============================================================================

# Pivot to wide format for easier comparison
summary_wide <- sensitivity_results %>%
  dplyr::select(analysis, threshold_label, n_species, p_value, effect_size_1v6) %>%
  pivot_wider(
    names_from = analysis,
    values_from = c(p_value, effect_size_1v6),
    names_glue = "{analysis}_{.value}"
  )

write_csv(
  summary_wide,
  here("output", "MRB", "tables", "sensitivity_summary_wide.csv")
)

# ==============================================================================
# CREATE SENSITIVITY FIGURES
# ==============================================================================

cat("\n=== Generating Figures ===\n")

# Figure 1: Heatmap of p-values across thresholds
p_heatmap <- sensitivity_results %>%
  filter(analysis == "CAFI_PC1_treatment") %>%
  ggplot(aes(x = factor(min_abund), y = factor(min_prev), fill = -log10(p_value))) +
  geom_tile(color = "white", linewidth = 0.5) +
  geom_text(aes(label = sprintf("%.3f", p_value)), color = "white", size = 3) +
  scale_fill_gradient2(
    low = "gray80", mid = "steelblue", high = "darkblue",
    midpoint = -log10(0.05),
    name = expression(-log[10](p))
  ) +
  labs(
    title = "Sensitivity of Treatment Effect on CAFI Composition",
    subtitle = "p-values across species filtering thresholds",
    x = "Minimum Abundance Threshold",
    y = "Minimum Prevalence Threshold"
  ) +
  theme_cafi_pub() +
  theme(
    legend.position = "right",
    panel.grid = element_blank()
  ) +
  # Add reference box for main analysis (10/10)
  annotate("rect", xmin = 1.5, xmax = 2.5, ymin = 1.5, ymax = 2.5,
           fill = NA, color = "red", linewidth = 1.5)

# Figure 2: Effect sizes across thresholds
p_effects <- sensitivity_results %>%
  filter(analysis == "CAFI_PC1_treatment") %>%
  ggplot(aes(x = n_species, y = abs(effect_size_1v6))) +
  geom_point(aes(color = significant_05), size = 3) +
  geom_smooth(method = "loess", se = TRUE, color = "gray40", alpha = 0.2) +
  geom_vline(xintercept = 38, linetype = "dashed", color = "red") +
  scale_color_manual(
    values = c("TRUE" = "darkgreen", "FALSE" = "gray60"),
    name = "p < 0.05"
  ) +
  labs(
    title = "Effect Size Stability Across Thresholds",
    subtitle = "Red line = main analysis (10/10 rule, 38 species)",
    x = "Number of Species Retained",
    y = "Effect Size (|1 vs 6 difference|)"
  ) +
  theme_cafi_pub()

# Figure 3: Number of species by threshold
p_nspecies <- sensitivity_results %>%
  filter(analysis == "CAFI_PC1_treatment") %>%
  ggplot(aes(x = factor(min_prev), y = n_species, group = factor(min_abund))) +
  geom_line(aes(color = factor(min_abund)), linewidth = 1) +
  geom_point(aes(color = factor(min_abund)), size = 3) +
  geom_hline(yintercept = 38, linetype = "dashed", color = "red") +
  scale_color_viridis_d(name = "Min.\nAbundance") +
  labs(
    title = "Species Retained by Filtering Threshold",
    subtitle = "Red line = main analysis (38 species)",
    x = "Minimum Prevalence Threshold",
    y = "Number of Species"
  ) +
  theme_cafi_pub()

# Combine figures
combined_sensitivity <- (p_heatmap | p_effects) / p_nspecies +
  plot_annotation(
    title = "Sensitivity Analysis: Species Filtering Thresholds",
    tag_levels = "A"
  )

# Save figures
ggsave(
  here("output", "MRB", "figures", "publication-figures", "sensitivity_analysis_combined.pdf"),
  combined_sensitivity,
  width = 14, height = 10, dpi = 600
)

ggsave(
  here("output", "MRB", "figures", "publication-figures", "sensitivity_analysis_combined.png"),
  combined_sensitivity,
  width = 14, height = 10, dpi = 600
)

cat("Figures saved to: output/MRB/figures/publication-figures/\n")

# ==============================================================================
# SUMMARY STATISTICS
# ==============================================================================

cat("\n=== SENSITIVITY ANALYSIS SUMMARY ===\n\n")

# Main analysis (10/10)
main_result <- sensitivity_results %>%
  filter(min_prev == 10, min_abund == 10, analysis == "CAFI_PC1_treatment")

if (nrow(main_result) > 0) {
  cat("Main Analysis (10/10 rule):\n")
  cat("  Species:", main_result$n_species, "\n")
  cat("  p-value:", round(main_result$p_value, 4), "\n")
  cat("  Effect size:", round(main_result$effect_size_1v6, 3), "\n\n")
}

# Range across all thresholds
cafi_results <- sensitivity_results %>%
  filter(analysis == "CAFI_PC1_treatment")

if (nrow(cafi_results) > 0) {
  cat("Across All Thresholds:\n")
  cat("  p-value range:", round(min(cafi_results$p_value), 4), "-",
      round(max(cafi_results$p_value), 4), "\n")
  cat("  Effect size range:", round(min(abs(cafi_results$effect_size_1v6)), 3), "-",
      round(max(abs(cafi_results$effect_size_1v6)), 3), "\n")
  cat("  Significant at 0.05:", sum(cafi_results$significant_05), "/",
      nrow(cafi_results), "\n")
  cat("  Significant at 0.10:", sum(cafi_results$significant_10), "/",
      nrow(cafi_results), "\n\n")

  # Qualitative conclusion
  if (all(cafi_results$significant_10)) {
    cat("CONCLUSION: Results ROBUST - all thresholds significant at α=0.10\n")
  } else if (mean(cafi_results$significant_10) > 0.8) {
    cat("CONCLUSION: Results MOSTLY ROBUST - >80% of thresholds significant\n")
  } else {
    cat("CONCLUSION: Results SENSITIVE to threshold choice\n")
  }
}

# ==============================================================================
# CREATE MARKDOWN SUMMARY TABLE
# ==============================================================================

cat("\n=== Creating Markdown Summary ===\n")

# Create nice markdown table for the manuscript
md_table <- sensitivity_results %>%
  filter(analysis == "CAFI_PC1_treatment") %>%
  arrange(min_prev, min_abund) %>%
  mutate(
    Threshold = paste0(min_prev, " / ", min_abund),
    `N Species` = n_species,
    `Var. Expl. (%)` = sprintf("%.1f", var_pc1 * 100),
    `χ²` = sprintf("%.2f", chi_sq),
    `p-value` = sprintf("%.4f", p_value),
    `Sig.` = case_when(
      p_value < 0.001 ~ "***",
      p_value < 0.01 ~ "**",
      p_value < 0.05 ~ "*",
      p_value < 0.10 ~ ".",
      TRUE ~ ""
    ),
    `Effect Size` = sprintf("%.3f", effect_size_1v6)
  ) %>%
  dplyr::select(Threshold, `N Species`, `Var. Expl. (%)`, `χ²`, `p-value`, `Sig.`, `Effect Size`)

# Write markdown
md_output <- c(
  "# Sensitivity Analysis: Species Filtering Thresholds",
  "",
  "## Treatment Effect on CAFI Community Composition (PC1)",
  "",
  "| Threshold (Prev/Abund) | N Species | Var. Expl. (%) | χ² | p-value | Sig. | Effect Size |",
  "|:----------------------:|:---------:|:-------------:|:---:|:-------:|:----:|:-----------:|",
  apply(md_table, 1, function(row) {
    paste("|", paste(row, collapse = " | "), "|")
  }),
  "",
  "**Notes:**",
  "- Threshold format: Minimum Prevalence / Minimum Abundance",
  "- Main analysis uses 10/10 rule (highlighted)",
  "- Effect size = Mean PC1(1-colony) - Mean PC1(6-colony)",
  "- Significance: *** p<0.001, ** p<0.01, * p<0.05, . p<0.10",
  ""
)

writeLines(md_output, here("output", "MRB", "tables", "sensitivity_analysis_summary.md"))
cat("Markdown summary saved to: output/MRB/tables/sensitivity_analysis_summary.md\n")

cat("\n=== Analysis Complete ===\n")
