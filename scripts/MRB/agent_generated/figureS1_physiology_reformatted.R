# ==============================================================================
# Figure S1: Physiology Metrics by Treatment (Reformatted)
# ==============================================================================
# Purpose: Generate Figure S1 with y-axis labels directly on each panel
#          (instead of as facet strip titles), per Craig's feedback
#
# Original: Uses facet_wrap with titles like "Protein", "Carbohydrate"
# Updated: Individual panels combined with patchwork, y-axis labels spelled out
#
# Generated by: CAFI Agent System
# Generated on: 2026-01-11
# ==============================================================================

# Source standard libraries and utilities
source("scripts/MRB/1.libraries.R")
source("scripts/MRB/utils.R")
source("scripts/MRB/mrb_figure_standards.R")

# ==============================================================================
# LOAD DATA (following pattern from 7.coral-physiology.R)
# ==============================================================================

# strip_fe() defined in utils.R - sourced above

# Load growth data from script 6 (contains filtered >=80% alive corals)
coral_growth <- read_csv(
  here("data", "processed", "coral_growth.csv"),
  show_col_types = FALSE
)

# Extract IDs of corals with >=80% alive
keep_ids <- coral_growth$coral_id

# Create metadata from coral_growth
meta_df <- coral_growth %>%
  dplyr::select(coral_id, treatment, reef, percent_alive)

# Load physiology data
physio_raw <- read_csv(
  here("data", "MRB Amount", "1. amount_master_phys_data_v5.csv"),
  show_col_types = FALSE
) %>%
  mutate(coral_id = strip_fe(as.character(coral_id)))

# Merge and filter
physio_df <- physio_raw %>%
  left_join(meta_df, by = "coral_id") %>%
  filter(coral_id %in% keep_ids) %>%
  mutate(treatment = factor(treatment))

# Rename for clarity in plotting
physio_df <- physio_df %>%
  rename(
    protein = protein_mg_cm2,
    carbohydrate = carb_mg_cm2,
    zooxanthellae = zoox_cells_cm2,
    afdw = afdw_mg_cm2
  )

cat("Sample size for Figure S1:", nrow(physio_df), "corals\n")
cat("By treatment:\n")
print(table(physio_df$treatment))

# ==============================================================================
# CREATE INDIVIDUAL PANELS WITH Y-AXIS LABELS
# ==============================================================================

# Common elements for all panels
base_theme <- theme_cafi_pub() +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),  # Will add x-label to bottom panel only
    plot.margin = margin(5, 10, 5, 10)
  )

# Panel A: Protein (matching Figure 4A style)
panel_protein <- ggplot(physio_df, aes(x = treatment, y = protein, fill = treatment)) +
  geom_violin(trim = FALSE, alpha = 0.6, colour = NA) +
  geom_boxplot(width = 0.2, fill = "white", outlier.shape = NA, alpha = 0.95) +
  geom_jitter(width = 0.15, size = 1.8, alpha = 0.7, colour = "gray30") +
  scale_fill_manual(values = TREATMENT_COLORS) +
  labs(y = expression(Protein~(mg~cm^{-2})),
       x = "Number of corals") +
  base_theme +
  theme(axis.title.x = element_text(margin = margin(t = 10)))

# Panel B: Carbohydrate (matching Figure 4A style)
panel_carb <- ggplot(physio_df, aes(x = treatment, y = carbohydrate, fill = treatment)) +
  geom_violin(trim = FALSE, alpha = 0.6, colour = NA) +
  geom_boxplot(width = 0.2, fill = "white", outlier.shape = NA, alpha = 0.95) +
  geom_jitter(width = 0.15, size = 1.8, alpha = 0.7, colour = "gray30") +
  scale_fill_manual(values = TREATMENT_COLORS) +
  labs(y = expression(Carbohydrate~(mg~cm^{-2})),
       x = "Number of corals") +
  base_theme +
  theme(axis.title.x = element_text(margin = margin(t = 10)))

# Panel C: Zooxanthellae (matching Figure 4A style)
panel_zoox <- ggplot(physio_df, aes(x = treatment, y = zooxanthellae / 1e6, fill = treatment)) +
  geom_violin(trim = FALSE, alpha = 0.6, colour = NA) +
  geom_boxplot(width = 0.2, fill = "white", outlier.shape = NA, alpha = 0.95) +
  geom_jitter(width = 0.15, size = 1.8, alpha = 0.7, colour = "gray30") +
  scale_fill_manual(values = TREATMENT_COLORS) +
  labs(y = expression(Zooxanthellae~(cells~cm^{-2})),
       x = "Number of corals") +
  base_theme +
  theme(axis.title.x = element_text(margin = margin(t = 10)))

# Panel D: Tissue biomass (AFDW) - matching Figure 4A style exactly
panel_afdw <- ggplot(physio_df, aes(x = treatment, y = afdw, fill = treatment)) +
  geom_violin(trim = FALSE, alpha = 0.6, colour = NA) +
  geom_boxplot(width = 0.2, fill = "white", outlier.shape = NA, alpha = 0.95) +
  geom_jitter(width = 0.15, size = 1.8, alpha = 0.7, colour = "gray30") +
  scale_fill_manual(values = TREATMENT_COLORS) +
  labs(y = expression(Tissue~biomass~(AFDW~mg~cm^{-2})),
       x = "Number of corals") +
  base_theme +
  theme(axis.title.x = element_text(margin = margin(t = 10)))

# ==============================================================================
# COMBINE PANELS WITH PATCHWORK
# ==============================================================================

figureS1_combined <- (panel_protein | panel_carb) / (panel_zoox | panel_afdw) +
  plot_annotation(
    tag_levels = 'A',
    theme = theme(plot.tag = element_text(face = "bold", size = 14))
  )

# ==============================================================================
# SAVE FIGURE
# ==============================================================================

# Output directory - save to publication/supplemental
out_dir <- here("output", "MRB", "figures", "publication", "supplemental")
dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)

# Save as PDF (publication quality)
ggsave(
  file.path(out_dir, "FigureS1_physiology_metrics.pdf"),
  figureS1_combined,
  width = 10,
  height = 8,
  dpi = 600,
  bg = "white"
)

# Save as PNG (for review)
ggsave(
  file.path(out_dir, "FigureS1_physiology_metrics.png"),
  figureS1_combined,
  width = 10,
  height = 8,
  dpi = 600,
  bg = "white"
)

message("Figure S1 saved to: output/MRB/figures/publication/supplemental/")
message("  - FigureS1_physiology_metrics.pdf")
message("  - FigureS1_physiology_metrics.png")

# ==============================================================================
# ALSO CREATE SIZE-CORRECTED GROWTH PANEL (if needed for 5th panel)
# ==============================================================================

# Check if growth data is available
if ("sc_growth" %in% names(physio_df) || "size_corrected_growth" %in% names(physio_df)) {
  growth_var <- if ("sc_growth" %in% names(physio_df)) "sc_growth" else "size_corrected_growth"

  panel_growth <- ggplot(physio_df, aes(x = treatment, y = .data[[growth_var]], fill = treatment)) +
    geom_violin(trim = FALSE, alpha = 0.6, colour = NA) +
    geom_boxplot(width = 0.2, fill = "white", outlier.shape = NA, alpha = 0.95) +
    geom_jitter(width = 0.15, size = 1.8, alpha = 0.7, colour = "gray30") +
    scale_fill_manual(values = TREATMENT_COLORS) +
    labs(y = "Size-corrected growth") +
    base_theme

  # 5-panel version
  figureS1_5panel <- (panel_protein | panel_carb | panel_zoox) /
                      (panel_afdw | panel_growth | plot_spacer()) +
    plot_annotation(tag_levels = 'A')

  ggsave(
    file.path(out_dir, "figureS1_physiology_5panel.pdf"),
    figureS1_5panel,
    width = 12,
    height = 8,
    dpi = 600,
    bg = "white"
  )

  message("5-panel version also saved.")
}

cat("\n=== Figure S1 Reformatting Complete ===\n")
