# ==============================================================================
        # Treatment Effect Analysis: abundance
        # ==============================================================================
        # Purpose: Analyze treatment effects on CAFI Abundance
        #
        # Inputs:
        #   #   - cafi
        #
        # Outputs:
        #   #   - abundance_treatment_effect.csv
#   - abundance_boxplot.png
        #
        # Dependencies:
        #   #   - 1.libraries.R
        #
        # Generated by: CAFI Agent System
        # Generated on: 2026-01-11 06:08
        # ==============================================================================

        # Load libraries and utilities
        source(here::here("scripts", "MRB", "1.libraries.R"))
        source(here::here("scripts", "MRB", "utils.R"))
        source(here::here("scripts", "MRB", "mrb_figure_standards.R"))

# ==============================================================================
# LOAD DATA
# ==============================================================================

cafi_data <- load_cafi_data()
treatment_data <- load_treatment_data()


# ==============================================================================
# MERGE DATA
# ==============================================================================

analysis_data <- cafi_data %>%
  left_join(treatment_data, by = "coral_id") %>%
  filter(!is.na(treatment))

# ------------------------------------------------------------------------------
# Mixed-Effects Model: abundance_model
# ------------------------------------------------------------------------------

# Fit the model
abundance_model <- lmer(
  abundance ~ treatment + (1 | reef),
  data = analysis_data
)

# Model summary
cat("\n=== Model Summary: abundance_model ===\n")
print(summary(abundance_model))

# Type III Wald chi-square tests
abundance_model_anova <- car::Anova(abundance_model, type = 3)
cat("\n=== ANOVA Table ===\n")
print(abundance_model_anova)

# Tidy output for reporting
abundance_model_tidy <- broom.mixed::tidy(abundance_model, effects = "fixed", conf.int = TRUE)
print(abundance_model_tidy)# Estimated marginal means
abundance_model_emmeans <- emmeans(abundance_model, specs = ~ treatment)
cat("\n=== Estimated Marginal Means ===\n")
print(abundance_model_emmeans)# Post-hoc pairwise comparisons
abundance_model_posthoc <- pairs(abundance_model_emmeans, adjust = "tukey")
cat("\n=== Post-hoc Comparisons (Tukey) ===\n")
print(abundance_model_posthoc)

# ------------------------------------------------------------------------------
# abundance_plot
# ------------------------------------------------------------------------------

abundance_plot <- ggplot(analysis_data, aes(x = treatment, y = abundance, fill = treatment)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.7) +
  labs(
    title = "Treatment Effect on CAFI Abundance",
    x = "Treatment (# Corals)",
    y = "CAFI Abundance"
  ) +
  theme_cafi_pub()

# Apply treatment color scale
abundance_plot <- abundance_plot +
  scale_fill_manual(values = treatment_colors, labels = treatment_labels)
# Save figure
save_both(
  abundance_plot,
  here::here("output/MRB/figures/abundance_treatment"),
  width = 8,
  height = 6
)

