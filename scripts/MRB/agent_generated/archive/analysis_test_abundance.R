# ==============================================================================
        # Statistical Analysis: test_abundance
        # ==============================================================================
        # Purpose: LMM analysis of abundance ~ treatment
        #
        # Inputs:
        #   #   - Data: cafi
#   - Data: treatment
        #
        # Outputs:
        #   #   - Table: test_abundance_results
        #
        # Dependencies:
        #   #   - 1.libraries.R
        #
        # Generated by: CAFI Agent System
        # Generated on: 2026-01-11 06:09
        # ==============================================================================

        # Load libraries and utilities
        source(here::here("scripts", "MRB", "1.libraries.R"))
        source(here::here("scripts", "MRB", "utils.R"))
        source(here::here("scripts", "MRB", "mrb_figure_standards.R"))

# ==============================================================================
# LOAD DATA
# ==============================================================================

cafi_data <- load_cafi_data()
treatment_data <- load_treatment_data()

# ==============================================================================
# STATISTICAL ANALYSES
# ==============================================================================

# ------------------------------------------------------------------------------
# Mixed-Effects Model: test_abundance_model
# ------------------------------------------------------------------------------

# Fit the model
test_abundance_model <- lmer(
  abundance ~ treatment + (1 | reef),
  data = analysis_data
)

# Model summary
cat("\n=== Model Summary: test_abundance_model ===\n")
print(summary(test_abundance_model))

# Type III Wald chi-square tests
test_abundance_model_anova <- car::Anova(test_abundance_model, type = 3)
cat("\n=== ANOVA Table ===\n")
print(test_abundance_model_anova)

# Tidy output for reporting
test_abundance_model_tidy <- broom.mixed::tidy(test_abundance_model, effects = "fixed", conf.int = TRUE)
print(test_abundance_model_tidy)# Estimated marginal means
test_abundance_model_emmeans <- emmeans(test_abundance_model, specs = ~ treatment)
cat("\n=== Estimated Marginal Means ===\n")
print(test_abundance_model_emmeans)# Post-hoc pairwise comparisons
test_abundance_model_posthoc <- pairs(test_abundance_model_emmeans, adjust = "tukey")
cat("\n=== Post-hoc Comparisons (Tukey) ===\n")
print(test_abundance_model_posthoc)

# ==============================================================================
# SAVE RESULTS
# ==============================================================================

# Save results to CSV
write_csv(
  test_abundance_results,
  here::here("output", "MRB", "tables", "test_abundance_results.csv")
)
message("Saved: test_abundance_results.csv")

# ==============================================================================
# ANALYSIS COMPLETE
# ==============================================================================
message("Analysis complete: test_abundance")
# ------------------------------------------------------------------------------
# test_abundance_plot
# ------------------------------------------------------------------------------

test_abundance_plot <- ggplot(analysis_data, aes(x = treatment, y = abundance, fill = treatment)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.7) +
  labs(
    title = "abundance by treatment",
    x = "treatment",
    y = "abundance"
  ) +
  theme_cafi_pub()

# Apply treatment color scale
test_abundance_plot <- test_abundance_plot +
  scale_fill_manual(values = treatment_colors, labels = treatment_labels)
# Save figure
save_both(
  test_abundance_plot,
  here::here("output/MRB/figures/agent_generated/test_abundance"),
  width = 8,
  height = 6
)

