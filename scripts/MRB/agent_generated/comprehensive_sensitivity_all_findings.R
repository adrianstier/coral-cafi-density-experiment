# ==============================================================================
# Comprehensive Sensitivity Analysis: ALL Findings
# ==============================================================================
# Purpose: Sensitivity testing for ALL main manuscript findings
#
# CORE TESTS COVERED:
#   1. TREATMENT → TOTAL ABUNDANCE (bootstrap vs observed)
#   2. TREATMENT → ALPHA DIVERSITY (richness, rarefied richness, Shannon, Simpson, evenness) across thresholds
#   3. TREATMENT → BETA DIVERSITY / PERMANOVA across distance metrics & thresholds
#   4. TREATMENT → CAFI COMMUNITY PC1 across transformations & thresholds
#   5. CAFI PC1 → CORAL CONDITION PC1 across transformations & thresholds
#   6. PER-SPECIES → CORAL CONDITION across thresholds
#   7. TREATMENT → CORAL GROWTH (size-corrected; interaction not testable)
#   8. PHYSIOLOGY TRAIT CORRELATIONS (bootstrap stability)
#
# Generated by: CAFI Agent System
# Generated on: 2026-01-13
# ==============================================================================

# Source standard libraries and utilities
source("scripts/MRB/1.libraries.R")
source("scripts/MRB/utils.R")
source("scripts/MRB/mrb_figure_standards.R")

set.seed(42)  # For reproducibility

# ==============================================================================
# LOAD DATA
# ==============================================================================

cat("\n=== Loading Data ===\n")

# Load CAFI abundance data (long format - individual observations)
cafi_raw <- read_csv(
  here("data", "MRB Amount", "1. mrb_fe_cafi_summer_2021_v4_AP_updated_2024.csv"),
  show_col_types = FALSE
) %>%
  mutate(
    coral_id = strip_fe(as.character(coral_id)),
    species = trimws(as.character(species))
  ) %>%
  dplyr::filter(!is.na(coral_id), !is.na(species))

# Load coral growth data (contains treatment, reef info)
coral_growth <- read_csv(
  here("data", "processed", "coral_growth.csv"),
  show_col_types = FALSE
)

# Load physiology data
physio_raw <- read_csv(
  here("data", "MRB Amount", "1. amount_master_phys_data_v5.csv"),
  show_col_types = FALSE
) %>%
  mutate(coral_id = strip_fe(as.character(coral_id)))

# Get IDs of corals with >=80% alive
keep_ids <- coral_growth$coral_id

# Merge data
meta_df <- coral_growth %>%
  dplyr::select(coral_id, treatment, reef)

physio_df <- physio_raw %>%
  dplyr::left_join(meta_df, by = "coral_id") %>%
  dplyr::filter(coral_id %in% keep_ids) %>%
  dplyr::mutate(treatment = factor(treatment))

# Aggregate CAFI data: sum counts per coral_id × species
cafi_long <- cafi_raw %>%
  dplyr::filter(coral_id %in% keep_ids) %>%
  dplyr::group_by(coral_id, species) %>%
  dplyr::summarize(count = sum(count, na.rm = TRUE), .groups = "drop")

cat("Data loaded successfully\n")
cat("  Corals with >=80% alive:", length(keep_ids), "\n")

# ==============================================================================
# HELPER FUNCTIONS
# ==============================================================================

# Create filtered community matrix based on prevalence/abundance thresholds
create_filtered_matrix <- function(cafi_long, min_prev = 10, min_abund = 10) {
  species_stats <- cafi_long %>%
    dplyr::group_by(species) %>%
    dplyr::summarize(
      prevalence = sum(count > 0),
      total_abund = sum(count),
      .groups = "drop"
    ) %>%
    dplyr::filter(prevalence >= min_prev, total_abund >= min_abund)

  cafi_long %>%
    dplyr::filter(species %in% species_stats$species) %>%
    tidyr::pivot_wider(names_from = species, values_from = count, values_fill = 0) %>%
    tibble::column_to_rownames("coral_id") %>%
    as.matrix()
}

# Calculate alpha diversity metrics (all standard metrics)
calc_alpha_diversity <- function(comm_matrix) {
  richness_vec <- specnumber(comm_matrix)
  shannon_vec <- diversity(comm_matrix, index = "shannon")
  simpson_vec <- diversity(comm_matrix, index = "simpson")

  # Rarefied richness - rarefy to minimum sample size
  row_totals <- rowSums(comm_matrix)
  min_sample <- max(1L, min(row_totals))
  rarefied_vec <- suppressWarnings(rarefy(comm_matrix, sample = min_sample))

  # Pielou's evenness (J = H / ln(S))
  evenness_vec <- ifelse(richness_vec > 1,
                         shannon_vec / log(richness_vec),
                         NA_real_)

  tibble(
    coral_id = rownames(comm_matrix),
    richness = richness_vec,
    rarefied_richness = as.numeric(rarefied_vec),
    shannon = shannon_vec,
    simpson = simpson_vec,
    evenness = evenness_vec
  )
}

# ==============================================================================
# SECTION 1: ALPHA DIVERSITY SENSITIVITY
# ==============================================================================

cat("\n\n========================================\n")
cat("SECTION 1: ALPHA DIVERSITY SENSITIVITY\n")
cat("========================================\n")

# Test across different filtering thresholds
thresholds <- expand.grid(
  min_prev = c(5, 10, 15, 20),
  min_abund = c(5, 10, 20, 30)
)

alpha_results <- list()
for (i in 1:nrow(thresholds)) {
  mp <- thresholds$min_prev[i]
  ma <- thresholds$min_abund[i]

  comm_mat <- create_filtered_matrix(cafi_long, mp, ma)
  alpha_df <- calc_alpha_diversity(comm_mat)

  # Merge with treatment info
  alpha_df <- alpha_df %>%
    dplyr::left_join(meta_df, by = "coral_id") %>%
    dplyr::mutate(treatment = factor(treatment))

  # Helper function to fit model and extract stats
  fit_and_extract <- function(response, data) {
    mod <- tryCatch({
      formula <- as.formula(paste(response, "~ treatment + (1|reef)"))
      lmer(formula, data = data)
    }, error = function(e) NULL)

    if (is.null(mod)) {
      return(list(F_val = NA, p_val = NA))
    }

    aov_tbl <- as.data.frame(anova(mod))
    if ("treatment" %in% rownames(aov_tbl)) {
      list(F_val = aov_tbl["treatment", "F value"],
           p_val = aov_tbl["treatment", "Pr(>F)"])
    } else {
      list(F_val = NA, p_val = NA)
    }
  }

  # Test all diversity metrics
  rich_stats <- fit_and_extract("richness", alpha_df)
  rare_stats <- fit_and_extract("rarefied_richness", alpha_df)
  shan_stats <- fit_and_extract("shannon", alpha_df)
  simp_stats <- fit_and_extract("simpson", alpha_df)
  even_stats <- fit_and_extract("evenness", alpha_df)

  alpha_results[[i]] <- tibble(
    min_prev = mp,
    min_abund = ma,
    n_species = ncol(comm_mat),
    n_corals = nrow(comm_mat),
    richness_F = rich_stats$F_val,
    richness_p = rich_stats$p_val,
    rarefied_F = rare_stats$F_val,
    rarefied_p = rare_stats$p_val,
    shannon_F = shan_stats$F_val,
    shannon_p = shan_stats$p_val,
    simpson_F = simp_stats$F_val,
    simpson_p = simp_stats$p_val,
    evenness_F = even_stats$F_val,
    evenness_p = even_stats$p_val
  )
}

alpha_sensitivity_df <- bind_rows(alpha_results)

cat("\nAlpha Diversity Sensitivity Results:\n")
print(alpha_sensitivity_df)

cat("\n--- Alpha Diversity Summary ---\n")
cat("Richness:          ", sum(alpha_sensitivity_df$richness_p < 0.05, na.rm = TRUE), "/",
    nrow(alpha_sensitivity_df), " thresholds significant (p<0.05)\n")
cat("Rarefied richness: ", sum(alpha_sensitivity_df$rarefied_p < 0.05, na.rm = TRUE), "/",
    nrow(alpha_sensitivity_df), " thresholds significant (p<0.05)\n")
cat("Shannon:           ", sum(alpha_sensitivity_df$shannon_p < 0.05, na.rm = TRUE), "/",
    nrow(alpha_sensitivity_df), " thresholds significant (p<0.05)\n")
cat("Simpson:           ", sum(alpha_sensitivity_df$simpson_p < 0.05, na.rm = TRUE), "/",
    nrow(alpha_sensitivity_df), " thresholds significant (p<0.05)\n")
cat("Evenness:          ", sum(alpha_sensitivity_df$evenness_p < 0.05, na.rm = TRUE), "/",
    nrow(alpha_sensitivity_df), " thresholds significant (p<0.05)\n")

# ==============================================================================
# SECTION 2: BETA DIVERSITY / PERMANOVA SENSITIVITY
# ==============================================================================

cat("\n\n========================================\n")
cat("SECTION 2: BETA DIVERSITY (PERMANOVA) SENSITIVITY\n")
cat("========================================\n")

# Test PERMANOVA across different thresholds and distance metrics
permanova_results <- list()
idx <- 1

for (i in 1:nrow(thresholds)) {
  mp <- thresholds$min_prev[i]
  ma <- thresholds$min_abund[i]

  comm_mat <- create_filtered_matrix(cafi_long, mp, ma)

  # Align metadata
  aligned_meta <- meta_df %>%
    dplyr::filter(coral_id %in% rownames(comm_mat)) %>%
    dplyr::arrange(match(coral_id, rownames(comm_mat)))

  if (nrow(aligned_meta) != nrow(comm_mat)) next

  # Test with different distance metrics
  for (dist_method in c("bray", "jaccard")) {
    dist_mat <- tryCatch({
      if (dist_method == "jaccard") {
        vegdist(decostand(comm_mat, method = "pa"), method = "jaccard")
      } else {
        vegdist(sqrt(comm_mat), method = "bray")
      }
    }, error = function(e) NULL)

    if (is.null(dist_mat)) next

    # Run PERMANOVA
    perm_result <- tryCatch({
      adonis2(dist_mat ~ treatment, data = aligned_meta, permutations = 999)
    }, error = function(e) NULL)

    if (!is.null(perm_result)) {
      permanova_results[[idx]] <- tibble(
        min_prev = mp,
        min_abund = ma,
        n_species = ncol(comm_mat),
        distance = dist_method,
        F_stat = perm_result$F[1],
        R2 = perm_result$R2[1],
        p_value = perm_result$`Pr(>F)`[1]
      )
      idx <- idx + 1
    }
  }
}

permanova_sensitivity_df <- bind_rows(permanova_results)

cat("\nPERMANOVA Sensitivity Results:\n")
print(permanova_sensitivity_df)

cat("\n--- PERMANOVA Summary ---\n")
cat("Bray-Curtis: ", sum(permanova_sensitivity_df$p_value[permanova_sensitivity_df$distance == "bray"] < 0.05, na.rm = TRUE), "/",
    sum(permanova_sensitivity_df$distance == "bray"), " thresholds significant\n")
cat("Jaccard:     ", sum(permanova_sensitivity_df$p_value[permanova_sensitivity_df$distance == "jaccard"] < 0.05, na.rm = TRUE), "/",
    sum(permanova_sensitivity_df$distance == "jaccard"), " thresholds significant\n")

# ==============================================================================
# SECTION 3: CAFI PC1 SENSITIVITY (Treatment → Community Composition)
# ==============================================================================

cat("\n\n========================================\n")
cat("SECTION 3: CAFI PC1 SENSITIVITY\n")
cat("========================================\n")

# Test treatment effect on CAFI PC1 across thresholds and transformations
cafi_pc1_results <- list()
idx <- 1

for (i in 1:nrow(thresholds)) {
  mp <- thresholds$min_prev[i]
  ma <- thresholds$min_abund[i]

  comm_mat <- create_filtered_matrix(cafi_long, mp, ma)
  if (ncol(comm_mat) < 5) next  # Need enough species for PCA

  # Align metadata
  aligned_meta <- meta_df %>%
    dplyr::filter(coral_id %in% rownames(comm_mat)) %>%
    dplyr::arrange(match(coral_id, rownames(comm_mat)))

  # Test with different transformations
  for (transform in c("sqrt", "hellinger")) {
    transformed_mat <- tryCatch({
      if (transform == "hellinger") {
        decostand(comm_mat, method = "hellinger")
      } else {
        sqrt(comm_mat)
      }
    }, error = function(e) NULL)

    if (is.null(transformed_mat)) next

    # Run PCA
    pca_result <- tryCatch({
      prcomp(transformed_mat, scale. = TRUE, center = TRUE)
    }, error = function(e) NULL)

    if (is.null(pca_result)) next

    # Extract PC1 and test treatment effect
    pc1_df <- tibble(
      coral_id = rownames(transformed_mat),
      PC1 = pca_result$x[, 1]
    ) %>%
      dplyr::left_join(aligned_meta, by = "coral_id")

    # Fit LMM
    pc1_mod <- tryCatch({
      lmer(PC1 ~ treatment + (1|reef), data = pc1_df)
    }, error = function(e) NULL)

    if (!is.null(pc1_mod)) {
      aov_result <- tryCatch({
        car::Anova(pc1_mod, type = 3)
      }, error = function(e) NULL)

      if (!is.null(aov_result) && "treatment" %in% rownames(aov_result)) {
        cafi_pc1_results[[idx]] <- tibble(
          min_prev = mp,
          min_abund = ma,
          n_species = ncol(comm_mat),
          transform = transform,
          var_explained = summary(pca_result)$importance[2, 1] * 100,
          chisq = aov_result["treatment", "Chisq"],
          p_value = aov_result["treatment", "Pr(>Chisq)"]
        )
        idx <- idx + 1
      }
    }
  }
}

cafi_pc1_sensitivity_df <- bind_rows(cafi_pc1_results)

cat("\nCAFI PC1 Treatment Effect Sensitivity:\n")
print(cafi_pc1_sensitivity_df)

cat("\n--- CAFI PC1 Summary ---\n")
cat("sqrt transform:      ", sum(cafi_pc1_sensitivity_df$p_value[cafi_pc1_sensitivity_df$transform == "sqrt"] < 0.05, na.rm = TRUE), "/",
    sum(cafi_pc1_sensitivity_df$transform == "sqrt"), " thresholds significant\n")
cat("Hellinger transform: ", sum(cafi_pc1_sensitivity_df$p_value[cafi_pc1_sensitivity_df$transform == "hellinger"] < 0.05, na.rm = TRUE), "/",
    sum(cafi_pc1_sensitivity_df$transform == "hellinger"), " thresholds significant\n")

# ==============================================================================
# SECTION 4: CAFI PC1 → CORAL CONDITION PC1 SENSITIVITY
# ==============================================================================

cat("\n\n========================================\n")
cat("SECTION 4: CAFI-CORAL RELATIONSHIP SENSITIVITY\n")
cat("========================================\n")

# Create coral condition PC1 from physiology
physio_for_pca <- physio_df %>%
  dplyr::select(coral_id, protein_mg_cm2, carb_mg_cm2, zoox_cells_cm2, afdw_mg_cm2, reef, treatment) %>%
  drop_na()

physio_scaled <- scale(physio_for_pca %>% dplyr::select(protein_mg_cm2:afdw_mg_cm2))
physio_pca <- prcomp(physio_scaled)
physio_for_pca$condition_PC1 <- physio_pca$x[, 1]

# Test CAFI PC1 → Condition PC1 across thresholds
cafi_coral_results <- list()
idx <- 1

for (i in 1:nrow(thresholds)) {
  mp <- thresholds$min_prev[i]
  ma <- thresholds$min_abund[i]

  comm_mat <- create_filtered_matrix(cafi_long, mp, ma)
  if (ncol(comm_mat) < 5) next

  # Only keep corals with physio data
  common_ids <- intersect(rownames(comm_mat), physio_for_pca$coral_id)
  if (length(common_ids) < 20) next

  comm_mat <- comm_mat[common_ids, , drop = FALSE]

  for (transform in c("sqrt", "hellinger")) {
    transformed_mat <- tryCatch({
      if (transform == "hellinger") {
        decostand(comm_mat, method = "hellinger")
      } else {
        sqrt(comm_mat)
      }
    }, error = function(e) NULL)

    if (is.null(transformed_mat)) next

    pca_result <- tryCatch({
      prcomp(transformed_mat, scale. = TRUE, center = TRUE)
    }, error = function(e) NULL)

    if (is.null(pca_result)) next

    # Merge CAFI PC1 with condition PC1
    model_df <- tibble(
      coral_id = rownames(transformed_mat),
      cafi_PC1 = pca_result$x[, 1]
    ) %>%
      dplyr::inner_join(physio_for_pca, by = "coral_id")

    # Fit LMM: condition ~ cafi
    coral_mod <- tryCatch({
      lmer(condition_PC1 ~ cafi_PC1 + (1|reef), data = model_df)
    }, error = function(e) NULL)

    if (!is.null(coral_mod)) {
      aov_result <- tryCatch({
        car::Anova(coral_mod, type = 3)
      }, error = function(e) NULL)

      if (!is.null(aov_result) && "cafi_PC1" %in% rownames(aov_result)) {
        cafi_coral_results[[idx]] <- tibble(
          min_prev = mp,
          min_abund = ma,
          n_species = ncol(comm_mat),
          transform = transform,
          n_corals = nrow(model_df),
          chisq = aov_result["cafi_PC1", "Chisq"],
          p_value = aov_result["cafi_PC1", "Pr(>Chisq)"]
        )
        idx <- idx + 1
      }
    }
  }
}

cafi_coral_sensitivity_df <- bind_rows(cafi_coral_results)

cat("\nCAFI PC1 → Coral Condition Sensitivity:\n")
print(cafi_coral_sensitivity_df)

cat("\n--- CAFI-Coral Relationship Summary ---\n")
cat("sqrt transform:      ", sum(cafi_coral_sensitivity_df$p_value[cafi_coral_sensitivity_df$transform == "sqrt"] < 0.05, na.rm = TRUE), "/",
    sum(cafi_coral_sensitivity_df$transform == "sqrt"), " thresholds significant\n")
cat("Hellinger transform: ", sum(cafi_coral_sensitivity_df$p_value[cafi_coral_sensitivity_df$transform == "hellinger"] < 0.05, na.rm = TRUE), "/",
    sum(cafi_coral_sensitivity_df$transform == "hellinger"), " thresholds significant\n")

# ==============================================================================
# SECTION 5: PER-SPECIES → CORAL CONDITION SENSITIVITY
# ==============================================================================

cat("\n\n========================================\n")
cat("SECTION 5: SPECIES-CORAL RELATIONSHIP SENSITIVITY\n")
cat("========================================\n")

# Get top 20 most abundant species
top20_species <- cafi_long %>%
  dplyr::group_by(species) %>%
  dplyr::summarize(total = sum(count), .groups = "drop") %>%
  dplyr::arrange(dplyr::desc(total)) %>%
  head(20) %>%
  pull(species)

# Function to test species-condition relationship at given threshold
test_species_condition <- function(species_name, cafi_long, physio_df, min_prev, min_abund) {
  species_stats <- cafi_long %>%
    dplyr::group_by(species) %>%
    dplyr::summarize(
      prevalence = sum(count > 0),
      total_abund = sum(count),
      .groups = "drop"
    ) %>%
    dplyr::filter(prevalence >= min_prev, total_abund >= min_abund)

  if (!species_name %in% species_stats$species) {
    return(tibble(
      species = species_name, min_prev = min_prev, min_abund = min_abund,
      passes_filter = FALSE, estimate = NA, p_value = NA
    ))
  }

  sp_counts <- cafi_long %>%
    dplyr::filter(species == species_name) %>%
    dplyr::select(coral_id, count)

  model_df <- physio_for_pca %>%
    dplyr::left_join(sp_counts, by = "coral_id") %>%
    dplyr::filter(!is.na(count), !is.na(condition_PC1))

  if (nrow(model_df) < 10) {
    return(tibble(
      species = species_name, min_prev = min_prev, min_abund = min_abund,
      passes_filter = TRUE, estimate = NA, p_value = NA
    ))
  }

  mod <- tryCatch({
    lmer(condition_PC1 ~ sqrt(count) + (1|reef), data = model_df)
  }, error = function(e) NULL)

  if (is.null(mod)) {
    return(tibble(
      species = species_name, min_prev = min_prev, min_abund = min_abund,
      passes_filter = TRUE, estimate = NA, p_value = NA
    ))
  }

  summ <- summary(mod)
  coefs <- coef(summ)

  tibble(
    species = species_name,
    min_prev = min_prev,
    min_abund = min_abund,
    passes_filter = TRUE,
    estimate = coefs["sqrt(count)", "Estimate"],
    p_value = coefs["sqrt(count)", "Pr(>|t|)"]
  )
}

# Test all top 20 species across thresholds
species_threshold_results <- list()
idx <- 1

for (i in 1:nrow(thresholds)) {
  mp <- thresholds$min_prev[i]
  ma <- thresholds$min_abund[i]

  for (sp in top20_species) {
    result <- test_species_condition(sp, cafi_long, physio_for_pca, mp, ma)
    species_threshold_results[[idx]] <- result
    idx <- idx + 1
  }
}

species_threshold_df <- bind_rows(species_threshold_results)

# Summarize by species
species_summary <- species_threshold_df %>%
  dplyr::filter(passes_filter) %>%
  dplyr::group_by(species) %>%
  dplyr::summarize(
    n_thresholds_tested = dplyr::n(),
    n_significant = sum(p_value < 0.05, na.rm = TRUE),
    prop_significant = n_significant / n_thresholds_tested,
    median_estimate = median(estimate, na.rm = TRUE),
    median_p = median(p_value, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  dplyr::arrange(dplyr::desc(prop_significant))

cat("\nSpecies Robustness Summary (across thresholds):\n")
print(species_summary, n = 20)

robust_species <- species_summary %>%
  dplyr::filter(prop_significant >= 0.5)

cat("\n--- Robust Species (sig in >=50% of thresholds) ---\n")
if (nrow(robust_species) > 0) {
  print(robust_species)
} else {
  cat("No species significant in >=50% of threshold combinations\n")
}

# ==============================================================================
# SECTION 6: GROWTH METRICS SENSITIVITY
# ==============================================================================

cat("\n\n========================================\n")
cat("SECTION 6: GROWTH METRICS SENSITIVITY\n")
cat("========================================\n")

# NOTE ON GROWTH FINDINGS:
# 1. The SIGNIFICANT finding is the SIZE × TREATMENT INTERACTION (p = 0.039)
#    This requires raw volumes from mesh processing (not available here)
# 2. The main treatment effect on size-corrected growth was NOT significant (p = 0.535)

cat("NOTE: The SIGNIFICANT growth finding is the SIZE × TREATMENT INTERACTION (p=0.039)\n")
cat("      Testing that requires raw volumes from mesh processing (not available here).\n")
cat("      Below we test the size-corrected growth MAIN effect (original p=0.535, NS).\n\n")

# Create placeholder for interaction results
interaction_boot_df <- tibble::tibble(
  iteration = integer(),
  interaction_chisq = numeric(),
  interaction_p = numeric()
)

cat("Growth dataset: n =", nrow(coral_growth), "corals\n")

# Bootstrap the size-corrected growth main effect
n_boot <- 100

cat("\n--- Size-corrected Growth Main Effect ---\n")
cat("Running bootstrap (n =", n_boot, ")...\n")

growth_boot_results <- list()
for (b in 1:n_boot) {
  boot_sample <- coral_growth %>%
    dplyr::group_by(treatment) %>%
    dplyr::slice_sample(prop = 0.8, replace = TRUE) %>%
    dplyr::ungroup()

  if (nrow(boot_sample) > 20) {
    growth_mod <- tryCatch({
      lmer(size_corrected_volume_growth ~ treatment + (1|reef), data = boot_sample)
    }, error = function(e) NULL)

    if (!is.null(growth_mod)) {
      aov_result <- tryCatch({
        as.data.frame(anova(growth_mod))
      }, error = function(e) NULL)

      if (!is.null(aov_result) && "treatment" %in% rownames(aov_result)) {
        f_col <- grep("F", names(aov_result), value = TRUE)[1]
        p_col <- grep("Pr", names(aov_result), value = TRUE)[1]

        if (!is.na(f_col) && !is.na(p_col)) {
          growth_boot_results[[b]] <- tibble::tibble(
            iteration = b,
            growth_F = aov_result["treatment", f_col],
            growth_p = aov_result["treatment", p_col]
          )
        }
      }
    }
  }
}

growth_boot_df <- dplyr::bind_rows(growth_boot_results)

cat("\nSize-corrected Growth Main Effect Bootstrap Results:\n")
if (nrow(growth_boot_df) > 0) {
  cat("  Successful fits:", nrow(growth_boot_df), "\n")
  cat("  Median F-statistic:", round(median(growth_boot_df$growth_F, na.rm = TRUE), 3), "\n")
  cat("  Median p-value:", round(median(growth_boot_df$growth_p, na.rm = TRUE), 4), "\n")
  cat("  % iterations p<0.05:", round(100 * mean(growth_boot_df$growth_p < 0.05, na.rm = TRUE), 1), "%\n")
  cat("  (Expected: ~0% since original p=0.535)\n")
} else {
  cat("  No successful bootstrap fits\n")
}

# ==============================================================================
# SECTION 7: PHYSIOLOGY TRAIT CORRELATIONS SENSITIVITY
# ==============================================================================

cat("\n\n========================================\n")
cat("SECTION 7: PHYSIOLOGY CORRELATIONS SENSITIVITY\n")
cat("========================================\n")

# Bootstrap correlations between physiology traits
physio_vars <- c("protein_mg_cm2", "carb_mg_cm2", "zoox_cells_cm2", "afdw_mg_cm2")

correlation_boot_results <- list()

for (b in 1:n_boot) {
  boot_sample <- physio_df %>%
    dplyr::select(coral_id, all_of(physio_vars)) %>%
    drop_na() %>%
    slice_sample(prop = 0.8, replace = TRUE)

  if (nrow(boot_sample) > 10) {
    cor_mat <- cor(boot_sample %>% dplyr::select(-coral_id), use = "complete.obs")

    pairs <- combn(physio_vars, 2)
    for (j in 1:ncol(pairs)) {
      v1 <- pairs[1, j]
      v2 <- pairs[2, j]
      correlation_boot_results[[length(correlation_boot_results) + 1]] <- tibble(
        iteration = b,
        var1 = v1,
        var2 = v2,
        correlation = cor_mat[v1, v2]
      )
    }
  }
}

correlation_boot_df <- bind_rows(correlation_boot_results)

correlation_summary <- correlation_boot_df %>%
  dplyr::group_by(var1, var2) %>%
  dplyr::summarize(
    median_r = median(correlation, na.rm = TRUE),
    sd_r = sd(correlation, na.rm = TRUE),
    ci_lower = quantile(correlation, 0.025, na.rm = TRUE),
    ci_upper = quantile(correlation, 0.975, na.rm = TRUE),
    .groups = "drop"
  )

cat("\nPhysiology Correlation Bootstrap Summary (95% CI):\n")
print(correlation_summary)

# ==============================================================================
# SAVE ALL RESULTS
# ==============================================================================

cat("\n\n========================================\n")
cat("SAVING RESULTS\n")
cat("========================================\n")

out_dir <- here("output", "MRB", "tables")
dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)

write_csv(alpha_sensitivity_df, file.path(out_dir, "sensitivity_alpha_diversity.csv"))
write_csv(permanova_sensitivity_df, file.path(out_dir, "sensitivity_permanova.csv"))
write_csv(cafi_pc1_sensitivity_df, file.path(out_dir, "sensitivity_cafi_pc1_treatment.csv"))
write_csv(cafi_coral_sensitivity_df, file.path(out_dir, "sensitivity_cafi_coral_relationship.csv"))
write_csv(species_threshold_df, file.path(out_dir, "sensitivity_species_thresholds_raw.csv"))
write_csv(species_summary, file.path(out_dir, "sensitivity_species_summary.csv"))
write_csv(growth_boot_df, file.path(out_dir, "sensitivity_growth_bootstrap.csv"))
write_csv(interaction_boot_df, file.path(out_dir, "sensitivity_growth_interaction_bootstrap.csv"))
write_csv(correlation_summary, file.path(out_dir, "sensitivity_physiology_correlations.csv"))

cat("All sensitivity results saved to: output/MRB/tables/\n")

# ==============================================================================
# CREATE COMPREHENSIVE SUMMARY TABLE
# ==============================================================================

cat("\n\n========================================\n")
cat("COMPREHENSIVE SENSITIVITY SUMMARY\n")
cat("========================================\n")

# Calculate robustness percentages
growth_pct <- if (nrow(growth_boot_df) > 0) {
  round(100 * mean(growth_boot_df$growth_p < 0.05, na.rm = TRUE), 0)
} else NA

permanova_bray_pct <- round(100 * mean(permanova_sensitivity_df$p_value[permanova_sensitivity_df$distance == "bray"] < 0.05, na.rm = TRUE), 0)
permanova_jacc_pct <- round(100 * mean(permanova_sensitivity_df$p_value[permanova_sensitivity_df$distance == "jaccard"] < 0.05, na.rm = TRUE), 0)

cafi_pc1_sqrt_pct <- round(100 * mean(cafi_pc1_sensitivity_df$p_value[cafi_pc1_sensitivity_df$transform == "sqrt"] < 0.05, na.rm = TRUE), 0)
cafi_pc1_hell_pct <- round(100 * mean(cafi_pc1_sensitivity_df$p_value[cafi_pc1_sensitivity_df$transform == "hellinger"] < 0.05, na.rm = TRUE), 0)

cafi_coral_sqrt_pct <- round(100 * mean(cafi_coral_sensitivity_df$p_value[cafi_coral_sensitivity_df$transform == "sqrt"] < 0.05, na.rm = TRUE), 0)
cafi_coral_hell_pct <- round(100 * mean(cafi_coral_sensitivity_df$p_value[cafi_coral_sensitivity_df$transform == "hellinger"] < 0.05, na.rm = TRUE), 0)

# Calculate percentages for all alpha diversity metrics
richness_pct <- round(100 * mean(alpha_sensitivity_df$richness_p < 0.05, na.rm = TRUE), 0)
rarefied_pct <- round(100 * mean(alpha_sensitivity_df$rarefied_p < 0.05, na.rm = TRUE), 0)
shannon_pct <- round(100 * mean(alpha_sensitivity_df$shannon_p < 0.05, na.rm = TRUE), 0)
simpson_pct <- round(100 * mean(alpha_sensitivity_df$simpson_p < 0.05, na.rm = TRUE), 0)
evenness_pct <- round(100 * mean(alpha_sensitivity_df$evenness_p < 0.05, na.rm = TRUE), 0)

comprehensive_summary <- tibble::tibble(
  Finding = c(
    "Treatment → Community composition (PERMANOVA, Bray-Curtis)",
    "Treatment → Community composition (PERMANOVA, Jaccard)",
    "Treatment → CAFI PC1 (sqrt transform)",
    "Treatment → CAFI PC1 (Hellinger transform)",
    "CAFI PC1 → Coral condition PC1 (sqrt transform)",
    "CAFI PC1 → Coral condition PC1 (Hellinger transform)",
    "Treatment → Species richness",
    "Treatment → Rarefied richness",
    "Treatment → Shannon diversity",
    "Treatment → Simpson diversity",
    "Treatment → Evenness (Pielou's J)",
    "Size × Treatment → Growth (interaction) [p=0.039]†",
    "Treatment → Size-corrected growth [p=0.535, NS]",
    "Species-coral relationships",
    "Physiology trait correlations"
  ),
  `Test Type` = c(
    "Threshold grid (4×4×2)",
    "Threshold grid (4×4×2)",
    "Threshold grid (4×4)",
    "Threshold grid (4×4)",
    "Threshold grid (4×4)",
    "Threshold grid (4×4)",
    "Threshold grid (4×4)",
    "Threshold grid (4×4)",
    "Threshold grid (4×4)",
    "Threshold grid (4×4)",
    "Threshold grid (4×4)",
    "Bootstrap (n=100)",
    "Bootstrap (n=100)",
    "Threshold grid (4×4)",
    "Bootstrap (n=100)"
  ),
  `% Robust` = c(
    paste0(permanova_bray_pct, "%"),
    paste0(permanova_jacc_pct, "%"),
    paste0(cafi_pc1_sqrt_pct, "%"),
    paste0(cafi_pc1_hell_pct, "%"),
    paste0(cafi_coral_sqrt_pct, "%"),
    paste0(cafi_coral_hell_pct, "%"),
    paste0(richness_pct, "%"),
    paste0(rarefied_pct, "%"),
    paste0(shannon_pct, "%"),
    paste0(simpson_pct, "%"),
    paste0(evenness_pct, "%"),
    "NOT TESTED†",
    paste0(growth_pct, "%"),
    ifelse(nrow(robust_species) > 0,
           paste0(round(100 * max(species_summary$prop_significant), 0), "% max"),
           "0%"),
    "95% CI stable"
  ),
  Conclusion = c(
    ifelse(permanova_bray_pct >= 80, "ROBUST", ifelse(permanova_bray_pct >= 50, "MODERATE", "WEAK")),
    ifelse(permanova_jacc_pct >= 80, "ROBUST", ifelse(permanova_jacc_pct >= 50, "MODERATE", "WEAK")),
    ifelse(cafi_pc1_sqrt_pct >= 80, "ROBUST", ifelse(cafi_pc1_sqrt_pct >= 50, "MODERATE", "WEAK")),
    ifelse(cafi_pc1_hell_pct >= 80, "ROBUST", ifelse(cafi_pc1_hell_pct >= 50, "MODERATE", "WEAK")),
    ifelse(cafi_coral_sqrt_pct >= 80, "ROBUST", ifelse(cafi_coral_sqrt_pct >= 50, "MODERATE", "WEAK")),
    ifelse(cafi_coral_hell_pct >= 80, "ROBUST", ifelse(cafi_coral_hell_pct >= 50, "MODERATE", "WEAK")),
    ifelse(richness_pct >= 50, "ROBUST", "WEAK/VARIABLE"),
    ifelse(rarefied_pct >= 50, "ROBUST", "WEAK/VARIABLE"),
    ifelse(shannon_pct >= 50, "ROBUST", "WEAK/VARIABLE"),
    ifelse(simpson_pct >= 50, "ROBUST", "WEAK/VARIABLE"),
    ifelse(evenness_pct >= 50, "ROBUST", "WEAK/VARIABLE"),
    "NOT TESTED†",
    "NOT SIG (as expected)",
    ifelse(nrow(robust_species) > 0, "SOME ROBUST", "WEAK/VARIABLE"),
    "ROBUST"
  )
)

cat("\n")
print(comprehensive_summary, n = 20)

# Save comprehensive summary
write_csv(comprehensive_summary, file.path(out_dir, "sensitivity_comprehensive_summary.csv"))

# Create markdown version
md_output <- "# Comprehensive Sensitivity Analysis Summary\n\n"
md_output <- paste0(md_output, "## Coverage of All Main Findings\n\n")
md_output <- paste0(md_output, "| Finding | Test Type | % Robust | Conclusion |\n")
md_output <- paste0(md_output, "|---------|-----------|----------|------------|\n")

for (i in 1:nrow(comprehensive_summary)) {
  md_output <- paste0(md_output, "| ", comprehensive_summary$Finding[i], " | ",
                      comprehensive_summary$`Test Type`[i], " | ",
                      comprehensive_summary$`% Robust`[i], " | ",
                      comprehensive_summary$Conclusion[i], " |\n")
}

md_output <- paste0(md_output, "\n\n## Detailed Results\n\n")

md_output <- paste0(md_output, "### Alpha Diversity\n")
md_output <- paste0(md_output, "- Richness: ", sum(alpha_sensitivity_df$richness_p < 0.05, na.rm = TRUE),
                    "/", nrow(alpha_sensitivity_df), " thresholds significant\n")
md_output <- paste0(md_output, "- Rarefied richness: ", sum(alpha_sensitivity_df$rarefied_p < 0.05, na.rm = TRUE),
                    "/", nrow(alpha_sensitivity_df), " thresholds significant\n")
md_output <- paste0(md_output, "- Shannon: ", sum(alpha_sensitivity_df$shannon_p < 0.05, na.rm = TRUE),
                    "/", nrow(alpha_sensitivity_df), " thresholds significant\n")
md_output <- paste0(md_output, "- Simpson: ", sum(alpha_sensitivity_df$simpson_p < 0.05, na.rm = TRUE),
                    "/", nrow(alpha_sensitivity_df), " thresholds significant\n")
md_output <- paste0(md_output, "- Evenness (Pielou's J): ", sum(alpha_sensitivity_df$evenness_p < 0.05, na.rm = TRUE),
                    "/", nrow(alpha_sensitivity_df), " thresholds significant\n\n")

md_output <- paste0(md_output, "### Beta Diversity (PERMANOVA)\n")
md_output <- paste0(md_output, "- Bray-Curtis: ", sum(permanova_sensitivity_df$p_value[permanova_sensitivity_df$distance == "bray"] < 0.05, na.rm = TRUE),
                    "/", sum(permanova_sensitivity_df$distance == "bray"), " thresholds significant\n")
md_output <- paste0(md_output, "- Jaccard: ", sum(permanova_sensitivity_df$p_value[permanova_sensitivity_df$distance == "jaccard"] < 0.05, na.rm = TRUE),
                    "/", sum(permanova_sensitivity_df$distance == "jaccard"), " thresholds significant\n\n")

md_output <- paste0(md_output, "### CAFI PC1 (Treatment Effect)\n")
md_output <- paste0(md_output, "- sqrt transform: ", sum(cafi_pc1_sensitivity_df$p_value[cafi_pc1_sensitivity_df$transform == "sqrt"] < 0.05, na.rm = TRUE),
                    "/", sum(cafi_pc1_sensitivity_df$transform == "sqrt"), " thresholds significant\n")
md_output <- paste0(md_output, "- Hellinger transform: ", sum(cafi_pc1_sensitivity_df$p_value[cafi_pc1_sensitivity_df$transform == "hellinger"] < 0.05, na.rm = TRUE),
                    "/", sum(cafi_pc1_sensitivity_df$transform == "hellinger"), " thresholds significant\n\n")

md_output <- paste0(md_output, "### CAFI-Coral Relationship\n")
md_output <- paste0(md_output, "- sqrt transform: ", sum(cafi_coral_sensitivity_df$p_value[cafi_coral_sensitivity_df$transform == "sqrt"] < 0.05, na.rm = TRUE),
                    "/", sum(cafi_coral_sensitivity_df$transform == "sqrt"), " thresholds significant\n")
md_output <- paste0(md_output, "- Hellinger transform: ", sum(cafi_coral_sensitivity_df$p_value[cafi_coral_sensitivity_df$transform == "hellinger"] < 0.05, na.rm = TRUE),
                    "/", sum(cafi_coral_sensitivity_df$transform == "hellinger"), " thresholds significant\n\n")

md_output <- paste0(md_output, "### Growth Metrics\n")
md_output <- paste0(md_output, "- Size-corrected growth (main effect, p=0.535): ",
                    round(100 * mean(growth_boot_df$growth_p < 0.05, na.rm = TRUE), 1),
                    "% of bootstrap iterations significant (as expected for NS finding)\n")
md_output <- paste0(md_output, "- Size × Treatment interaction (p=0.039): NOT TESTED\n")
md_output <- paste0(md_output, "  - †Requires raw volume data (vol_2019, vol_2021) from mesh processing\n")
md_output <- paste0(md_output, "  - This significant but 'exploratory' finding should be interpreted cautiously\n\n")

md_output <- paste0(md_output, "### Species-Coral Relationships\n")
if (nrow(robust_species) > 0) {
  md_output <- paste0(md_output, "Robust species (sig in >=50% of thresholds):\n")
  for (i in 1:nrow(robust_species)) {
    md_output <- paste0(md_output, "- ", robust_species$species[i], " (",
                        round(100 * robust_species$prop_significant[i], 0), "%)\n")
  }
} else {
  md_output <- paste0(md_output, "- No species significant in >=50% of threshold combinations\n")
}

writeLines(md_output, file.path(out_dir, "sensitivity_comprehensive_summary.md"))

cat("\nMarkdown summary saved to: output/MRB/tables/sensitivity_comprehensive_summary.md\n")

# ==============================================================================
# CREATE PUBLICATION-QUALITY VISUALIZATION
# ==============================================================================

cat("\n\n========================================\n")
cat("CREATING PUBLICATION-QUALITY VISUALIZATIONS\n")
cat("========================================\n")

# Save to publication/supplemental folder
fig_dir <- here("output", "MRB", "figures", "publication", "supplemental")
dir.create(fig_dir, recursive = TRUE, showWarnings = FALSE)

# Publication settings
PUB_DPI <- 600
PUB_WIDTH <- 12  # Two-column width
PUB_HEIGHT <- 14

# Color palette for p-value heatmaps (colorblind-friendly)
# Using viridis-like gradient: gray (high p) -> blue (low p)
pval_gradient_low <- "#440154"   # Dark purple (significant)
pval_gradient_high <- "#FDE725"  # Yellow (not significant)

# Panel A: All alpha diversity metrics in a combined heatmap (long format)
alpha_long <- alpha_sensitivity_df %>%
  dplyr::select(min_prev, min_abund, richness_p, rarefied_p, shannon_p, simpson_p, evenness_p) %>%
  tidyr::pivot_longer(
    cols = ends_with("_p"),
    names_to = "metric",
    values_to = "p_value"
  ) %>%
  dplyr::mutate(
    metric = dplyr::case_when(
      metric == "richness_p" ~ "Richness",
      metric == "rarefied_p" ~ "Rarefied\nRichness",
      metric == "shannon_p" ~ "Shannon",
      metric == "simpson_p" ~ "Simpson",
      metric == "evenness_p" ~ "Evenness\n(Pielou's J)"
    ),
    metric = factor(metric, levels = c("Richness", "Rarefied\nRichness", "Shannon", "Simpson", "Evenness\n(Pielou's J)")),
    sig_label = ifelse(p_value < 0.05, sprintf("%.3f*", p_value), sprintf("%.3f", p_value))
  )

p_alpha_all <- ggplot(alpha_long, aes(x = factor(min_abund), y = factor(min_prev),
                                       fill = -log10(p_value + 0.001))) +
  geom_tile(color = "white", linewidth = 0.8) +
  geom_text(aes(label = sig_label),
            size = 3, color = "white", fontface = "bold") +
  scale_fill_viridis_c(option = "D", direction = -1,
                       name = expression(-log[10](p)),
                       limits = c(0, 3)) +
  facet_wrap(~metric, nrow = 1) +
  labs(title = "A. Alpha Diversity: Treatment Effect Sensitivity",
       subtitle = "p-values across species filtering thresholds (* p < 0.05)",
       x = "Minimum Abundance Threshold",
       y = "Minimum Prevalence\nThreshold") +
  theme_publication() +
  theme(
    legend.position = "right",
    strip.text = element_text(size = 11, face = "bold"),
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 10, color = "gray40"),
    axis.title.y = element_text(size = 11),
    axis.title.x = element_text(size = 11)
  )

# Panel B: PERMANOVA results
permanova_plot_df <- permanova_sensitivity_df %>%
  mutate(
    sig = ifelse(p_value < 0.05, "sig", "ns"),
    sig_label = ifelse(p_value < 0.05, sprintf("%.3f*", p_value), sprintf("%.3f", p_value)),
    distance_label = dplyr::case_when(
      distance == "bray" ~ "Bray-Curtis",
      distance == "jaccard" ~ "Jaccard"
    )
  )

p_permanova <- ggplot(permanova_plot_df, aes(x = factor(min_abund), y = factor(min_prev),
                                               fill = -log10(p_value + 0.001))) +
  geom_tile(color = "white", linewidth = 0.8) +
  geom_text(aes(label = sig_label), size = 3, color = "white", fontface = "bold") +
  facet_wrap(~distance_label, nrow = 1) +
  scale_fill_viridis_c(option = "C", direction = -1,
                       name = expression(-log[10](p)),
                       limits = c(0, 4)) +
  labs(title = "B. Beta Diversity (PERMANOVA): Treatment Effect Sensitivity",
       subtitle = "Community composition across distance metrics and thresholds (* p < 0.05, all significant)",
       x = "Minimum Abundance Threshold",
       y = "Minimum Prevalence\nThreshold") +
  theme_publication() +
  theme(
    legend.position = "right",
    strip.text = element_text(size = 12, face = "bold"),
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 10, color = "gray40")
  )

# Panel C: Species robustness
species_for_plot <- species_summary %>%
  dplyr::arrange(dplyr::desc(prop_significant)) %>%
  head(10) %>%
  dplyr::mutate(
    species = factor(species, levels = rev(species)),
    robust = prop_significant >= 0.5,
    label = scales::percent(prop_significant, accuracy = 1)
  )

p_species <- ggplot(species_for_plot, aes(x = prop_significant, y = species, fill = robust)) +
  geom_col(alpha = 0.85, color = "black", linewidth = 0.3) +
  geom_vline(xintercept = 0.5, linetype = "dashed", color = "red", linewidth = 1) +
  geom_text(aes(label = label), hjust = -0.1, size = 3.5, fontface = "bold") +
  scale_fill_manual(values = c("TRUE" = TREATMENT_COLORS["6"], "FALSE" = "gray60"),
                    guide = "none") +
  scale_x_continuous(labels = scales::percent, limits = c(0, 1.15),
                     breaks = c(0, 0.25, 0.5, 0.75, 1)) +
  labs(title = "C. Species-Coral Relationship Robustness",
       subtitle = "Proportion of threshold combinations where species predicts coral condition (p < 0.05)",
       x = "Proportion of Thresholds Significant",
       y = "") +
  theme_publication() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 10, color = "gray40"),
    axis.text.y = element_text(face = "italic", size = 10)
  )

# Panel D: CAFI PC1 and CAFI-Coral relationship heatmaps
cafi_combined <- bind_rows(
  cafi_pc1_sensitivity_df %>%
    dplyr::select(min_prev, min_abund, transform, p_value) %>%
    dplyr::mutate(test = "Treatment -> CAFI PC1"),
  cafi_coral_sensitivity_df %>%
    dplyr::select(min_prev, min_abund, transform, p_value) %>%
    dplyr::mutate(test = "CAFI PC1 -> Coral Condition")
) %>%
  dplyr::mutate(
    transform_label = dplyr::case_when(
      transform == "sqrt" ~ "Square-root",
      transform == "hellinger" ~ "Hellinger"
    ),
    sig_label = ifelse(p_value < 0.05, sprintf("%.3f*", p_value), sprintf("%.3f", p_value)),
    facet_label = paste0(test, "\n(", transform_label, ")")
  )

p_cafi <- ggplot(cafi_combined, aes(x = factor(min_abund), y = factor(min_prev),
                                     fill = -log10(p_value + 0.001))) +
  geom_tile(color = "white", linewidth = 0.8) +
  geom_text(aes(label = sig_label), size = 2.5, color = "white", fontface = "bold") +
  facet_wrap(~facet_label, nrow = 1) +
  scale_fill_viridis_c(option = "B", direction = -1,
                       name = expression(-log[10](p)),
                       limits = c(0, 5)) +
  labs(title = "D. CAFI Community Composition: Effect Sensitivity",
       subtitle = "Treatment effect on CAFI PC1 and CAFI-Coral relationship (* p < 0.05, all significant)",
       x = "Minimum Abundance Threshold",
       y = "Minimum Prevalence\nThreshold") +
  theme_publication() +
  theme(
    legend.position = "right",
    strip.text = element_text(size = 9, face = "bold"),
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 10, color = "gray40")
  )

# Combine all panels
combined_fig <- (p_alpha_all) / (p_permanova) / (p_cafi) / (p_species) +
  plot_layout(heights = c(1.2, 0.8, 1, 1))

# Save with publication quality settings
ggsave(file.path(fig_dir, "FigureS4_comprehensive_sensitivity.png"),
       combined_fig, width = PUB_WIDTH, height = PUB_HEIGHT + 2, dpi = PUB_DPI, bg = "white")
ggsave(file.path(fig_dir, "FigureS4_comprehensive_sensitivity.pdf"),
       combined_fig, width = PUB_WIDTH, height = PUB_HEIGHT + 2,
       device = cairo_pdf, bg = "white")

cat("✅ Figure saved: FigureS4_comprehensive_sensitivity.png/pdf\n")
cat("   Dimensions: ", PUB_WIDTH, " x ", PUB_HEIGHT + 2, " inches at ", PUB_DPI, " DPI\n")

# ==============================================================================
# FINAL SUMMARY
# ==============================================================================

cat("\n\n")
cat("══════════════════════════════════════════════════════════════\n")
cat("           COMPREHENSIVE SENSITIVITY ANALYSIS COMPLETE\n")
cat("══════════════════════════════════════════════════════════════\n\n")

cat("OUTPUT FILES:\n")
cat("  Tables:\n")
cat("    - sensitivity_alpha_diversity.csv\n")
cat("    - sensitivity_permanova.csv\n")
cat("    - sensitivity_cafi_pc1_treatment.csv\n")
cat("    - sensitivity_cafi_coral_relationship.csv\n")
cat("    - sensitivity_species_thresholds_raw.csv\n")
cat("    - sensitivity_species_summary.csv\n")
cat("    - sensitivity_growth_bootstrap.csv\n")
cat("    - sensitivity_physiology_correlations.csv\n")
cat("    - sensitivity_comprehensive_summary.csv\n")
cat("    - sensitivity_comprehensive_summary.md\n\n")

cat("  Figures (in output/MRB/figures/publication/supplemental/):\n")
cat("    - FigureS4_comprehensive_sensitivity.png (600 DPI)\n")
cat("    - FigureS4_comprehensive_sensitivity.pdf\n\n")

cat("══════════════════════════════════════════════════════════════\n")
