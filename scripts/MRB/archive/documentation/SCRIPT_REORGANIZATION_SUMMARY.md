# MRB Script Reorganization Summary

**Date:** 2025-11-05
**Status:** ✅ COMPLETE

---

## Overview

Script 6 was too large (1085 lines, 30K+ tokens) making it difficult to read and maintain. It has been split into two logical components, and all subsequent scripts have been renumbered accordingly.

---

## Changes Made

### 1. Script 6 Split into Two Parts

**Old:** `6.coral.R` (1085 lines - growth + physiology combined)

**New:**
- **6.coral-growth.R** (513 lines) - Coral growth analysis only
  - Sections 1-11: Mesh data processing, growth metrics, ANCOVA
  - Exports: `coral_growth.csv`, `coral_growth.rds`

- **7.coral-physiology.R** (568 lines) - Physiology integration
  - Sections 13-18: Physiology + growth PCA, mixed models
  - Depends on: `coral_growth.csv` from script 6

### 2. All Subsequent Scripts Renumbered

| Old Name | New Name | Description |
|----------|----------|-------------|
| `7.coral-caffi.R` | `8.coral-caffi.R` | CAFI community × coral performance |
| `8.null-models.R` | `9.null-models.R` | Null model analysis |
| `9.coral-physio.R` | `10.coral-physio.R` | Coral physiology & community ordination |
| `11.nmds_permanova_cafi.R` | `12.nmds_permanova_cafi.R` | NMDS and PERMANOVA |
| `12.SLOSS.R` | `13.SLOSS.R` | SLOSS analysis |

---

## Complete Script List (Current)

1. `1.libraries.R` - Package loading
2. `2.taxonomic-coverage.R` - Taxonomic coverage analysis
3. `3.abundance.R` - Abundance patterns
4. `4d.diversity.R` - Diversity analysis
5. `5.fishes.R` - Fish community analysis
6. **`6.coral-growth.R`** - **Coral growth analysis** (NEW - part 1 of old script 6)
7. **`7.coral-physiology.R`** - **Physiology integration** (NEW - part 2 of old script 6)
8. `8.coral-caffi.R` - CAFI × coral performance (was 7)
9. `9.null-models.R` - Null models (was 8)
10. `10.coral-physio.R` - Coral physiology & community (was 9)
11. *(gap - no script 11)*
12. `12.nmds_permanova_cafi.R` - NMDS/PERMANOVA (was 11)
13. `13.SLOSS.R` - SLOSS analysis (was 12)

---

## Dependency Updates

### Scripts Updated:
1. ✅ **6.coral-growth.R** - New header, exports data for script 7
2. ✅ **7.coral-physiology.R** - New header, loads data from script 6
3. ✅ **8.coral-caffi.R** - Header updated (was 7)
4. ✅ **9.null-models.R** - Header updated (was 8)
5. ✅ **10.coral-physio.R** - Header updated (was 9), references updated
6. ✅ **12.nmds_permanova_cafi.R** - Header updated (was 11)
7. ✅ **13.SLOSS.R** - Header updated (was 12)
8. ✅ **run_mrb_pipeline.R** - Script list updated

### Key Dependency Chain:
```
6.coral-growth.R
  ↓ (exports coral_growth.csv)
7.coral-physiology.R
  ↓ (can run independently after script 6)
8.coral-caffi.R
```

---

## Testing Status

### Scripts 6 & 7 Testing ✅ COMPLETE

Both new scripts have been tested and run successfully:

**Issues Found and Fixed:**
1. **Missing backward-compatible aliases**: Scripts 6 & 7 were calling `show_and_save()` which doesn't exist in the new standards
   - **Fix**: Added backward-compatible alias functions after sourcing standards:
   ```r
   # Backward-compatible aliases for old function names
   show_and_save <- function(plot, filename, w = 8, h = 6, ...) {
     filename <- tools::file_path_sans_ext(filename)
     save_figure(plot = plot, filename = filename, width = w, height = h, ...)
   }
   save_both <- show_and_save  # Alias
   ```

2. **Duplicate `name` parameter in scale functions**: Plots were calling `scale_color_treatment(name = "Treatment")` but the function already sets a default name
   - **Fix**: Removed `name = "Treatment"` parameter from all `scale_color_treatment()` and `scale_fill_treatment()` calls
   - Locations fixed:
     - Script 6: Lines 354, 455
     - Script 7: Line 294

**Test Results:**
- ✅ Script 6.coral-growth.R: Completed successfully, exported coral_growth.csv
- ✅ Script 7.coral-physiology.R: Completed successfully, loaded growth data and generated all figures

### Full Pipeline Testing ✅ COMPLETE

**Pipeline run completed successfully on 2025-11-05:**
- ✅ All 11 scripts executed without errors
- ✅ Total execution time: 30.85 minutes
- ✅ Generated 87 PNG figures + 68 PDF figures = **155 total figure files**

**Scripts tested (all passed):**
1. ✅ 2.taxonomic-coverage.R (5.97 seconds)
2. ✅ 3.abundance.R (21.22 seconds)
3. ✅ 4d.diversity.R (36.65 seconds)
4. ✅ 5.fishes.R (4.79 seconds)
5. ✅ 6.coral-growth.R (3.15 seconds)
6. ✅ 7.coral-physiology.R (completed successfully)
7. ✅ 8.coral-caffi.R (completed successfully)
8. ✅ 9.null-models.R (completed successfully)
9. ✅ 10.coral-physio.R (completed successfully)
10. ✅ 12.nmds_permanova_cafi.R (completed successfully)
11. ✅ 13.SLOSS.R (completed successfully)

**Figures generated by directory:**
- `output/MRB/figures/combined`: 35 PNG files
- `output/diversity`: 14 PNG files
- `output/MRB/figures/coral/physio`: 9 PNG files
- `output/MRB/figures/coral`: 6 PNG files
- `output/MRB/figures/abundance`: 6 PNG files
- `output/MRB/figures/ordination`: 5 PNG files
- `output/MRB/figures/taxonomic_coverage`: 4 PNG files
- `output/MRB/figures/fishes`: 4 PNG files
- `output/figures`: 2 PNG files
- `output/MRB/figures/null_models`: 2 PNG files

### Testing Recommendations

Run scripts in order to verify all work correctly:

```r
# Test the split scripts first
source("scripts/MRB/6.coral-growth.R")   # Should complete and export growth data
source("scripts/MRB/7.coral-physiology.R")  # Should load growth data and run

# Test renamed scripts
source("scripts/MRB/8.coral-caffi.R")
source("scripts/MRB/9.null-models.R")
source("scripts/MRB/10.coral-physio.R")
source("scripts/MRB/12.nmds_permanova_cafi.R")
source("scripts/MRB/13.SLOSS.R")

# Or run the full pipeline
source("scripts/MRB/run_mrb_pipeline.R")
```

---

## Benefits of This Reorganization

1. **Improved Readability**
   - Script 6: 1085 lines → 513 lines (growth only)
   - Script 7: 568 lines (physiology only)
   - Each script now fits within token limits for AI assistants

2. **Logical Separation**
   - Growth analysis (mesh processing, ANCOVA) separate from physiology
   - Clear data flow: growth data exports → physiology imports

3. **Better Maintainability**
   - Easier to modify one analysis without affecting the other
   - Clearer dependencies and data flow

4. **Consistent Numbering**
   - All scripts now follow sequential numbering (except intentional gap at 11)
   - Headers updated to reflect new positions

---

## Files Modified

### New Files Created:
- `6.coral-growth.R` (from first half of old 6.coral.R)
- `7.coral-physiology.R` (from second half of old 6.coral.R)

### Files Renamed:
- `7.coral-caffi.R` → `8.coral-caffi.R`
- `8.null-models.R` → `9.null-models.R`
- `9.coral-physio.R` → `10.coral-physio.R`
- `11.nmds_permanova_cafi.R` → `12.nmds_permanova_cafi.R`
- `12.SLOSS.R` → `13.SLOSS.R`

### Files Deleted:
- `6.coral.R` (replaced by 6.coral-growth.R and 7.coral-physiology.R)

### Supporting Files Updated:
- `run_mrb_pipeline.R` (script list updated)
- All renamed scripts (headers updated with new numbers)

---

## Data Exports from Script 6

**Script 6 (6.coral-growth.R) now exports:**
- `data/processed/coral_growth.csv` - Used by script 7
- `data/processed/coral_growth.rds` - R object format
- `data/MRB Amount/coral_growth_surface_area_change_filtered.csv` - Filtered data

**Script 7 (7.coral-physiology.R) loads:**
- `data/processed/coral_growth.csv` from script 6
- `data/MRB Amount/1. amount_master_phys_data_v5.csv` (physiology data)

---

## Backward Compatibility

⚠️ **Breaking Changes:**
- Old references to `6.coral.R` must be updated to either:
  - `6.coral-growth.R` (for growth analysis)
  - `7.coral-physiology.R` (for physiology integration)

- Scripts 7-12 have new numbers (8-13)

**If you have:**
- Custom scripts that source old script names → Update to new names
- Documentation referencing old scripts → Update script numbers
- Analysis notebooks citing script numbers → Update references

---

## Questions?

- Script 6 growth data not found? → Run `6.coral-growth.R` first
- Script 7 fails to load data? → Check that `6.coral-growth.R` completed successfully
- Pipeline scripts not working? → Verify `run_mrb_pipeline.R` has updated script list

---

**All reorganization complete!** ✅
The repository now has better organization and all scripts use consistent numbering.
